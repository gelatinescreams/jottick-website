<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JotTick : A notes, checklists, and task management integration for Home Assistant. Now with Kanban support</title>
  <meta name="description" content="A notes, checklists, and task management integration for Home Assistant. Includes per device and list notification controls along with powerful recurring list functionality.">
  <meta name="keywords" content="JotTick, Home Assistant, HACS, notes, checklists, tasks, todo, task management, home automation, smart home, notifications, reminders, recurring tasks, Lovelace, dashboard, family organization, shopping list, productivity">
  <meta name="author" content="gelatinescreams">
  
<meta property="og:title" content="JotTick : A notes, checklists, and task management integration for Home Assistant">
<meta property="og:description" content="Jot notes. Tick tasks. Get notified. A powerful notes, checklists, and task management integration for Home Assistant with mobile notifications and recurring resets.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://github.com/gelatinescreams/JotTick">
<meta property="og:image" content="https://raw.githubusercontent.com/gelatinescreams/jottick-website/main/logo_readme.png">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="JotTick : A notes, checklists, and task management integration for Home Assistant">
<meta name="twitter:description" content="A notes, checklists, and task management integration for Home Assistant. Includes per device and list notification controls along with powerful recurring list functionality.">
<meta name="twitter:image" content="https://raw.githubusercontent.com/gelatinescreams/jottick-website/main/logo_readme.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0d0d14;
      --bg-secondary: #151520;
      --bg-card: #1a1a28;
      --bg-elevated: #22222f;
      --bg-sidebar: #101018;
      --accent: #03a9f4;
      --accent-hover: #29b6f6;
      --accent-muted: rgba(3, 169, 244, 0.15);
      --ha-blue: #03a9f4;
      --text-primary: #f0f0f5;
      --text-secondary: #8888a0;
      --text-muted: #5a5a70;
      --border: #2a2a3a;
      --success: #34d399;
      --success-muted: rgba(52, 211, 153, 0.15);
      --error: #f87171;
      --info: #60a5fa;
      --info-muted: rgba(96, 165, 250, 0.15);
      --warning: #fbbf24;
      --purple: #f59e0b;
      --purple-muted: rgba(245, 158, 11, 0.15);
      --voice: #10b981;
      --voice-muted: rgba(16, 185, 129, 0.15);
      --radius: 12px;
      --radius-sm: 8px;
      --sidebar-width: 56px;
      --sidebar-expanded: 256px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
      display: flex;
    }
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      z-index: 200;
      transition: width 0.2s ease;
      overflow: hidden;
    }
    .sidebar:hover { width: var(--sidebar-expanded); }
    .sidebar-header {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
      min-height: 56px;
    }
    .ha-logo { width: 32px; height: 32px; flex-shrink: 0; }
    .ha-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .sidebar:hover .ha-title { opacity: 1; }
    .sidebar-nav { flex: 1; overflow-y: auto; padding: 8px 0; }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
      border-left: 3px solid transparent;
    }
    .nav-item:hover { background: var(--bg-elevated); color: var(--text-primary); }
    .nav-item.active { background: var(--accent-muted); color: var(--accent); border-left-color: var(--accent); }
    .nav-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
    .nav-label { white-space: nowrap; font-size: 0.9rem; opacity: 0; transition: opacity 0.2s; }
    .sidebar:hover .nav-label { opacity: 1; }
    .nav-divider { height: 1px; background: var(--border); margin: 8px 12px; }
    .sidebar-footer { padding: 12px; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--ha-blue); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 600; color: white; flex-shrink: 0; }
    .user-name { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; opacity: 0; transition: opacity 0.2s; }
    .sidebar:hover .user-name { opacity: 1; }
    .app-container { flex: 1; margin-left: var(--sidebar-width); min-height: 100vh; display: flex; flex-direction: column; }
    .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border); padding: 12px 24px; position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-title { font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .header-title img { width: 28px; height: 28px; border-radius: 6px; }
    .demo-badge { background: var(--accent-muted); color: var(--accent); padding: 4px 10px; border-radius: 16px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .header-actions { display: flex; gap: 8px; }
    .header-btn { background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-secondary); padding: 8px 12px; border-radius: var(--radius-sm); font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.15s; text-decoration: none; }
    .header-btn:hover { background: var(--border); color: var(--text-primary); }
    .tabs-container { background: var(--bg-secondary); border-bottom: 1px solid var(--border); padding: 0 24px; }
    .tabs { display: flex; gap: 4px; }
    .tab { padding: 14px 20px; background: none; border: none; color: var(--text-secondary); font-family: inherit; font-size: 0.9rem; font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s; display: flex; align-items: center; gap: 8px; }
    .tab:hover { color: var(--text-primary); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-icon { font-size: 1rem; }
    .tab-count { background: var(--bg-elevated); padding: 2px 7px; border-radius: 10px; font-size: 0.7rem; color: var(--text-muted); }
    .tab.active .tab-count { background: var(--accent-muted); color: var(--accent); }
    .main { flex: 1; padding: 24px; }
    .tab-content { display: none; animation: fadeIn 0.25s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .create-form { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 24px; }
    .form-title { font-size: 0.95rem; font-weight: 600; margin-bottom: 14px; color: var(--text-primary); }
    .form-row { display: flex; gap: 12px; margin-bottom: 12px; }
    .form-row:last-child { margin-bottom: 0; }
    input[type="text"], input[type="password"], input[type="datetime-local"], input[type="time"], textarea, select {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.9rem;
      width: 100%;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    input::placeholder, textarea::placeholder { color: var(--text-muted); }
    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-muted); }
    textarea { min-height: 100px; resize: vertical; }
    select { cursor: pointer; }
    .btn { background: var(--accent); color: #fff; border: none; border-radius: var(--radius-sm); padding: 10px 18px; font-family: inherit; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.15s; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; }
    .btn:hover { background: var(--accent-hover); transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn-secondary { background: var(--bg-elevated); color: var(--text-primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--border); }
    .btn-danger { background: var(--error); color: white; }
    .btn-danger:hover { background: #ef4444; }
    .btn-success { background: var(--success); color: #000; }
    .btn-purple { background: var(--purple); color: #000; }
    .btn-sm { padding: 6px 10px; font-size: 0.8rem; }
    .btn-icon { padding: 6px; background: var(--bg-elevated); color: var(--text-secondary); }
    .btn-icon:hover { background: var(--border); color: var(--text-primary); }
    .btn-wrapper { position: relative; display: inline-block; }
    .btn-badge { position: absolute; top: -6px; right: -6px; background: var(--error); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 10px; font-weight: 600; }
    .toggle-group { display: flex; border-radius: var(--radius-sm); overflow: hidden; border: 1px solid var(--border); }
    .toggle-btn { padding: 7px 14px; background: var(--bg-elevated); border: none; color: var(--text-secondary); font-family: inherit; font-size: 0.8rem; cursor: pointer; transition: all 0.15s; }
    .toggle-btn.active { background: var(--accent); color: #fff; }
    .toggle-btn:not(.active):hover { background: var(--border); }
    .notes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(450px, 1fr)); gap: 16px; }
    .note-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; transition: all 0.15s; animation: cardIn 0.25s ease; }
    @keyframes cardIn { from { opacity: 0; transform: scale(0.96); } to { opacity: 1; transform: scale(1); } }
    @keyframes dissipate { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.95); } 100% { opacity: 0; transform: scale(0.9) translateY(-10px); } }
    .dissipating { animation: dissipate 0.4s ease-out forwards; pointer-events: none; }
    .note-card:hover { border-color: var(--accent); box-shadow: 0 4px 20px rgba(3, 169, 244, 0.08); }
    .note-card.voice-note { border-color: var(--voice); background: linear-gradient(135deg, var(--bg-card) 0%, rgba(16, 185, 129, 0.05) 100%); }
    .note-card.voice-note:hover { box-shadow: 0 4px 20px rgba(16, 185, 129, 0.15); }
    .note-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .note-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); flex: 1; }
    .note-badges { display: flex; gap: 6px; margin-left: 8px; }
    .badge { padding: 2px 7px; border-radius: 5px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; }
    .badge-md { background: rgba(96, 165, 250, 0.2); color: var(--info); }
    .badge-locked { background: rgba(248, 113, 113, 0.2); color: var(--error); }
    .badge-voice { background: var(--voice-muted); color: var(--voice); }
    .note-content { color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 10px; line-height: 1.6; }
    .note-content.markdown h1, .note-content.markdown h2, .note-content.markdown h3 { color: var(--text-primary); margin: 0.5em 0; }
    .note-content.markdown h1 { font-size: 1.3em; }
    .note-content.markdown h2 { font-size: 1.15em; }
    .note-content.markdown h3 { font-size: 1.05em; }
    .note-content.markdown code { background: var(--bg-elevated); padding: 2px 5px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.85em; }
    .note-content.markdown blockquote { border-left: 3px solid var(--accent); padding-left: 10px; color: var(--text-muted); margin: 0.5em 0; }
    .note-content.markdown ul, .note-content.markdown ol { padding-left: 1.5em; margin: 0.5em 0; }
    .note-images { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 6px; margin-bottom: 10px; }
    .note-image { aspect-ratio: 1; border-radius: 6px; overflow: hidden; cursor: pointer; }
    .note-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.15s; }
    .note-image:hover img { transform: scale(1.05); }
    .note-timestamp { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 10px; }
    .note-actions { display: flex; gap: 8px; padding-top: 10px; border-top: 1px solid var(--border); flex-wrap: wrap; }
    .voice-indicator { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--voice-muted); border-radius: var(--radius-sm); margin-bottom: 10px; }
    .voice-icon { font-size: 1.2rem; }
    .voice-text { font-size: 0.8rem; color: var(--voice); }
    .voice-countdown { font-weight: 600; color: var(--voice); }
    .locked-overlay { text-align: center; padding: 16px; }
    .locked-icon { font-size: 1.8rem; margin-bottom: 6px; }
    .locked-text { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 10px; }
    .unlock-form { display: flex; gap: 8px; }
    .unlock-form input { flex: 1; }
    .panel { margin-top: 12px; padding: 14px; border-radius: var(--radius-sm); display: none; animation: fadeIn 0.2s ease; }
    .panel.show { display: block; }
    .panel-send { background: var(--info-muted); border: 1px solid rgba(96, 165, 250, 0.3); }
    .panel-recurring { background: var(--success-muted); border: 1px solid rgba(52, 211, 153, 0.3); }
    .panel-reminder { background: var(--purple-muted); border: 1px solid rgba(167, 139, 250, 0.3); }
    .panel-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
    .panel-send .panel-title { color: var(--info); }
    .panel-recurring .panel-title { color: var(--success); }
    .panel-reminder .panel-title { color: var(--purple); }
    .panel-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; align-items: center; }
    .panel-row:last-child { margin-bottom: 0; }
    .panel-label { font-size: 0.8rem; color: var(--text-secondary); min-width: 60px; }
    .panel-devices { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .device-check { display: flex; align-items: center; gap: 5px; font-size: 0.85rem; cursor: pointer; padding: 6px 10px; background: var(--bg-card); border-radius: 6px; border: 1px solid var(--border); transition: all 0.15s; }
    .device-check:hover { border-color: var(--text-muted); }
    .device-check input { accent-color: var(--accent); }
    .mode-tabs { display: flex; gap: 0; margin-bottom: 12px; border-radius: 6px; overflow: hidden; border: 1px solid var(--border); }
    .mode-tab { flex: 1; padding: 8px 12px; background: var(--bg-card); color: var(--text-secondary); border: none; cursor: pointer; font-size: 0.8rem; font-family: inherit; transition: all 0.15s; }
    .mode-tab.active { background: var(--accent); color: #fff; }
    .mode-tab:not(.active):hover { background: var(--bg-elevated); }
    .schedule-section { display: none; padding: 12px; background: var(--bg-card); border-radius: 6px; margin-bottom: 12px; }
    .schedule-section.show { display: block; }
    .pending-schedules { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(96, 165, 250, 0.2); }
    .pending-title { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px; }
    .pending-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: var(--bg-card); border-radius: 6px; margin-bottom: 6px; font-size: 0.8rem; }
    .pending-info { color: var(--text-primary); }
    .pending-time { color: var(--text-muted); font-size: 0.75rem; }
    .panel-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
    .day-selector { display: flex; gap: 4px; flex-wrap: wrap; }
    .day-btn { padding: 6px 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; color: var(--text-secondary); font-size: 0.75rem; cursor: pointer; transition: all 0.15s; }
    .day-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .day-btn:hover:not(.active) { border-color: var(--text-muted); }
    .lists-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 16px; }
    #tasks-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 16px; }
    .list-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; animation: cardIn 0.25s ease; }
    .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; padding-bottom: 10px; border-bottom: 2px solid var(--accent); }
    .list-title { font-size: 1rem; font-weight: 600; }
    .list-progress { background: var(--accent); color: #fff; padding: 3px 10px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; }
    .list-items { margin-bottom: 14px; }
    .list-item { display: flex; align-items: center; gap: 10px; padding: 8px 10px; background: var(--bg-elevated); border-radius: var(--radius-sm); margin-bottom: 6px; transition: all 0.15s; }
    .list-item:hover { background: var(--border); }
    .item-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }
    .item-text { flex: 1; font-size: 0.9rem; }
    .item-text.completed { text-decoration: line-through; color: var(--text-muted); }
    .item-delete { opacity: 0; transition: opacity 0.15s; }
    .list-item:hover .item-delete { opacity: 1; }
    .add-item-form { display: flex; gap: 8px; padding-top: 10px; border-top: 1px solid var(--border); }
    .add-item-form input { flex: 1; }
    .list-actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .task-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 16px; animation: cardIn 0.25s ease; }
    .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; padding-bottom: 10px; border-bottom: 2px solid var(--accent); }
    .task-title { font-size: 1rem; font-weight: 600; }
    .task-progress { background: var(--accent); color: #fff; padding: 3px 10px; border-radius: 10px; font-size: 0.75rem; font-weight: 600; }
    .task-items { margin-bottom: 14px; }
    .task-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: var(--bg-elevated); border-radius: var(--radius-sm); margin-bottom: 5px; border-left: 3px solid var(--success); transition: all 0.15s; }
    .task-item:hover { background: var(--border); }
    .task-item.depth-1 { margin-left: 20px; border-left-color: var(--info); }
    .task-item.depth-2 { margin-left: 40px; border-left-color: var(--warning); }
    .task-item.depth-3 { margin-left: 60px; border-left-color: var(--accent); }
    .task-item-text { flex: 1; font-size: 0.9rem; }
    .task-item-text.completed { text-decoration: line-through; color: var(--text-muted); }
    .status-select { padding: 4px 6px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 5px; color: var(--text-primary); font-family: inherit; font-size: 0.75rem; cursor: pointer; width: auto; }
    .task-item-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.15s; }
    .task-item:hover .task-item-actions { opacity: 1; }
    .add-task-form { display: flex; gap: 8px; padding-top: 10px; border-top: 1px solid var(--border); flex-wrap: wrap; }
    .add-task-form input { flex: 1; min-width: 140px; }
    .task-actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .empty-state { text-align: center; padding: 50px 20px; color: var(--text-muted); }
    .empty-icon { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.5; }
    .empty-text { font-size: 1rem; margin-bottom: 6px; }
    .empty-hint { font-size: 0.85rem; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
    .modal-overlay.show { display: flex; }
    .modal-image { max-width: 90%; max-height: 90%; border-radius: var(--radius); }
    .modal-close { position: absolute; top: 20px; right: 20px; background: var(--bg-elevated); border: none; color: var(--text-primary); width: 36px; height: 36px; border-radius: 50%; font-size: 1.3rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .image-preview { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .preview-thumb { position: relative; width: 50px; height: 50px; border-radius: 6px; overflow: hidden; }
    .preview-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .preview-remove { position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: var(--error); color: white; border: none; border-radius: 50%; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .options-row { display: flex; gap: 14px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
    .option-group { display: flex; align-items: center; gap: 6px; }
    .option-group label { display: flex; align-items: center; gap: 5px; font-size: 0.85rem; color: var(--text-secondary); cursor: pointer; }
    .option-group input[type="checkbox"] { accent-color: var(--accent); }
    .password-field { display: none; margin-top: 8px; }
    .password-field.show { display: block; }
    .toast { position: fixed; bottom: 24px; right: 24px; background: var(--accent); color: #fff; padding: 10px 18px; border-radius: var(--radius-sm); font-weight: 500; font-size: 0.9rem; transform: translateY(100px); opacity: 0; transition: all 0.25s; z-index: 1000; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .file-label { display: inline-flex; align-items: center; gap: 5px; padding: 10px 14px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; font-size: 0.85rem; transition: all 0.15s; }
    .file-label:hover { background: var(--border); color: var(--text-primary); }
    .file-label input { display: none; }
    .config-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: var(--bg-elevated); border-radius: 4px; font-size: 0.7rem; color: var(--text-muted); margin-left: 6px; }
    .config-badge.active { background: var(--success-muted); color: var(--success); }
    .config-badge.reminder-active { background: var(--purple-muted); color: var(--purple); }
    .mobile-menu-btn { display: none; background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; padding: 4px 8px; margin-right: 8px; }
    .mobile-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 300; }
    .mobile-overlay.show { display: block; }
    .mobile-menu { position: fixed; top: 0; left: 0; width: 280px; height: 100vh; background: var(--bg-sidebar); z-index: 301; transform: translateX(-100%); transition: transform 0.25s ease; display: flex; flex-direction: column; }
    .mobile-menu.show { transform: translateX(0); }
    .mobile-menu-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .mobile-menu-header .logo-area { display: flex; align-items: center; gap: 10px; }
    .mobile-menu-header .logo-area img { width: 32px; height: 32px; border-radius: 8px; }
    .mobile-menu-header .logo-area span { font-size: 1.1rem; font-weight: 600; }
    .mobile-menu-close { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 4px; }
    .mobile-menu-nav { flex: 1; overflow-y: auto; padding: 12px 0; }
    .mobile-nav-item { display: flex; align-items: center; gap: 12px; padding: 14px 20px; color: var(--text-secondary); text-decoration: none; font-size: 0.95rem; transition: all 0.15s; }
    .mobile-nav-item:hover { background: var(--bg-elevated); color: var(--text-primary); }
    .mobile-nav-item.active { background: var(--accent-muted); color: var(--accent); }
    .mobile-nav-divider { height: 1px; background: var(--border); margin: 12px 16px; }
    .mobile-nav-section { padding: 8px 20px 6px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }
    .mobile-menu-footer { padding: 16px; border-top: 1px solid var(--border); }
    .mobile-menu-footer .reset-btn { width: 100%; padding: 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-secondary); font-family: inherit; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.15s; }
    .mobile-menu-footer .reset-btn:hover { background: var(--border); color: var(--text-primary); }
    
    .kanban-hint { background: var(--accent-muted); border: 1px solid rgba(3, 169, 244, 0.3); border-radius: var(--radius-sm); padding: 10px 16px; margin-bottom: 16px; font-size: 0.85rem; color: var(--text-secondary); display: none; }
    @media (max-width: 768px) { .kanban-hint { display: block; } }
    .kanban-container { display: flex; flex-direction: column; gap: 24px; }
    .kanban-task-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
    .kanban-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid var(--accent); }
    .kanban-title { font-size: 1.1rem; font-weight: 600; }
    .kanban-progress { background: var(--accent); color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
    .kanban-board { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 8px; }
    .kanban-board.vertical { flex-direction: column; }
    .kanban-column { min-width: 240px; flex: 1; background: var(--bg-elevated); border-radius: 10px; padding: 12px; display: flex; flex-direction: column; }
    .kanban-board.vertical .kanban-column { min-width: auto; }
    .kanban-col-header { display: flex; align-items: center; gap: 8px; padding: 10px; margin-bottom: 10px; border-radius: 8px; font-weight: 600; font-size: 0.95rem; }
    .kanban-col-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .kanban-col-count { margin-left: auto; background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 10px; font-size: 0.8rem; }
    .kanban-dropzone { flex: 1; min-height: 80px; border: 2px dashed transparent; border-radius: 8px; padding: 8px; transition: all 0.2s; display: flex; flex-direction: column; gap: 8px; }
    .kanban-dropzone.drag-over { background: var(--accent-muted); border-color: var(--accent); transform: scale(1.02); }
    .kanban-item { background: var(--bg-card); border-radius: 8px; padding: 12px; cursor: grab; border-left: 4px solid; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s; touch-action: pan-y; user-select: none; -webkit-user-select: none; }
    .kanban-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .kanban-item.dragging { opacity: 0.5; cursor: grabbing; }
    .kanban-item-text { font-size: 0.9rem; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
    .kanban-item-text::before { content: '‚ãÆ‚ãÆ'; color: var(--text-muted); font-size: 0.7rem; letter-spacing: -2px; opacity: 0.5; }
    @media (min-width: 769px) { .kanban-item-text::before { display: none; } .kanban-item:hover .kanban-item-text::before { display: inline; } }
    .kanban-item-children { margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 0.8rem; }
    .kanban-child { display: flex; align-items: center; gap: 6px; padding: 4px 0; color: var(--text-secondary); }
    .kanban-child-dot { width: 6px; height: 6px; border-radius: 50%; }
    .kanban-empty { text-align: center; padding: 20px; color: var(--text-muted); font-style: italic; font-size: 0.85rem; }
    .kanban-add-row { display: flex; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
    .kanban-add-row input { flex: 1; padding: 8px 10px; font-size: 0.85rem; }
    .kanban-add-row button { padding: 8px 12px; font-size: 0.8rem; }
    .kanban-layout-btn { padding: 6px 12px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); font-size: 0.8rem; cursor: pointer; margin-right: 10px; }
    .kanban-layout-btn:hover { background: var(--border); color: var(--text-primary); }
    
    .three-col-layout { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    .three-col-layout .col-1 { display: flex; flex-direction: column; gap: 20px; }
    .three-col-layout .col-2, .three-col-layout .col-3 { display: flex; flex-direction: column; gap: 16px; }
    
    .assist-config { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-top: 16px; }
    .assist-config h3 { font-size: 1rem; margin-bottom: 6px; }
    .assist-config .help { font-size: 0.85em; color: var(--text-secondary); margin-bottom: 12px; }
    .assist-section { background: var(--bg-elevated); border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .assist-section:last-child { margin-bottom: 0; }
    .assist-section-title { font-weight: 600; font-size: 0.9em; margin-bottom: 8px; }
    .assist-config select, .assist-config input[type="text"] { margin-bottom: 8px; }
    .assist-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: var(--bg-card); border-radius: 6px; margin: 4px 0; font-size: 0.85em; }
    .assist-item .del { padding: 4px 10px; background: var(--error); color: white; font-size: 0.8em; border: none; border-radius: 4px; cursor: pointer; }
    .assist-empty { font-style: italic; color: var(--text-muted); font-size: 0.85em; }
    .assist-status { font-size: 0.85em; color: var(--accent); margin-top: 8px; min-height: 18px; }
    .assist-pending { padding: 6px 10px; background: var(--bg-card); border-radius: 6px; margin: 4px 0; font-size: 0.85em; display: flex; justify-content: space-between; align-items: center; }
    
    .mini-cal { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; margin-top: 16px; }
    .mini-cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .mini-cal-title { font-size: 0.95em; font-weight: 600; display: flex; align-items: center; gap: 6px; }
    .mini-cal-nav { display: flex; gap: 4px; }
    .mini-cal-nav button { background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-primary); padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85em; }
    .mini-cal-nav button:hover { background: var(--border); }
    .mini-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; font-size: 0.75em; }
    .mini-cal-dow { text-align: center; padding: 4px 2px; color: var(--text-muted); font-weight: 600; }
    .mini-cal-day { text-align: center; padding: 6px 2px; cursor: pointer; border-radius: 4px; position: relative; }
    .mini-cal-day:hover { background: var(--bg-elevated); }
    .mini-cal-day.other { color: var(--text-muted); opacity: 0.5; }
    .mini-cal-day.today { background: var(--accent-muted); font-weight: 700; color: var(--accent); }
    .mini-cal-day.has-events::after { content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 50%; background: var(--accent); }
    .mini-cal-day.has-due::after { background: var(--success); }
    .mini-cal-day.has-overdue::after { background: var(--error); }
    .mini-cal-events { margin-top: 10px; border-top: 1px solid var(--border); padding-top: 10px; max-height: 120px; overflow-y: auto; }
    .mini-cal-event { display: flex; align-items: center; gap: 6px; padding: 4px 0; font-size: 0.85em; cursor: pointer; }
    .mini-cal-event:hover { color: var(--accent); }
    .mini-cal-event-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .mini-cal-event-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mini-cal-empty { font-size: 0.8em; color: var(--text-muted); text-align: center; padding: 8px; }
    .mini-cal-link { display: block; text-align: center; margin-top: 8px; font-size: 0.8em; color: var(--accent); cursor: pointer; }
    .mini-cal-link:hover { text-decoration: underline; }
    .mini-cal-overdue { background: rgba(248, 113, 113, 0.15); border: 1px solid var(--error); border-radius: 6px; padding: 8px; margin-bottom: 10px; font-size: 0.85em; display: flex; align-items: center; gap: 6px; color: var(--error); }
    
    .calendar-container { display: grid; grid-template-columns: 1fr 320px; gap: 24px; }
    .calendar-main { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
    .calendar-sidebar { display: flex; flex-direction: column; gap: 16px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
    .calendar-nav { display: flex; gap: 8px; align-items: center; }
    .calendar-nav-btn { background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-primary); width: 36px; height: 36px; border-radius: 6px; cursor: pointer; font-size: 1rem; }
    .calendar-nav-btn:hover { background: var(--border); }
    .calendar-month-title { font-size: 1.2rem; font-weight: 600; min-width: 180px; text-align: center; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); border-radius: 8px; overflow: hidden; }
    .calendar-weekday { background: var(--bg-elevated); padding: 12px 8px; text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
    .calendar-day { background: var(--bg-card); min-height: 80px; padding: 6px; position: relative; cursor: pointer; transition: all 0.15s; }
    .calendar-day:hover { background: var(--bg-elevated); }
    .calendar-day.other-month { background: var(--bg-primary); opacity: 0.5; }
    .calendar-day.today { background: var(--accent-muted); }
    .calendar-day.today .day-number { background: var(--accent); color: white; border-radius: 50%; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; }
    .day-number { font-size: 0.85rem; font-weight: 500; margin-bottom: 4px; }
    .day-events { display: flex; flex-direction: column; gap: 2px; }
    .day-event { font-size: 0.65rem; padding: 2px 4px; border-radius: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
    .day-event:hover { filter: brightness(1.2); }
    .day-more { font-size: 0.6rem; color: var(--text-muted); padding: 2px; }
    .calendar-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; }
    .calendar-panel-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .ical-input-group { margin-bottom: 12px; }
    .ical-input-group label { display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; }
    .ical-sources { margin-top: 12px; }
    .ical-source { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: var(--bg-elevated); border-radius: 6px; margin-bottom: 6px; font-size: 0.8rem; }
    .ical-source-name { color: var(--text-primary); }
    .ical-source-status { font-size: 0.7rem; color: var(--success); }
    .color-settings { display: flex; flex-direction: column; gap: 8px; }
    .color-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; }
    .color-label { font-size: 0.8rem; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; }
    .color-preview { width: 12px; height: 12px; border-radius: 3px; }
    .color-input { width: 50px; height: 26px; border: none; border-radius: 4px; cursor: pointer; background: transparent; }
    .upcoming-events { max-height: 250px; overflow-y: auto; }
    .upcoming-event { display: flex; gap: 10px; padding: 10px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 8px; align-items: flex-start; }
    .upcoming-event-dot { width: 10px; height: 10px; border-radius: 50%; margin-top: 4px; flex-shrink: 0; }
    .upcoming-event-content { flex: 1; min-width: 0; }
    .upcoming-event-title { font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .upcoming-event-time { font-size: 0.75rem; color: var(--text-muted); }
    .overdue-banner { background: rgba(248, 113, 113, 0.15); border: 1px solid var(--error); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
    .overdue-banner .overdue-count { font-weight: 700; color: var(--error); }

    .points-container { display: grid; grid-template-columns: 1fr 320px; gap: 24px; }
    .points-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    .points-sidebar { display: flex; flex-direction: column; gap: 16px; }
    .points-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; }
    .points-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .points-card-header h3 { font-size: 1rem; font-weight: 600; margin: 0; }
    .leaderboard-card { grid-column: 1 / -1; }
    .history-card { grid-column: 1 / -1; }
    .leaderboard-list { display: flex; flex-direction: column; gap: 8px; }
    .leaderboard-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-elevated); border-radius: 8px; }
    .leaderboard-rank { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 700; border-radius: 50%; font-size: 0.85rem; }
    .leaderboard-rank.gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
    .leaderboard-rank.silver { background: linear-gradient(135deg, #9ca3af, #6b7280); color: #fff; }
    .leaderboard-rank.bronze { background: linear-gradient(135deg, #d97706, #b45309); color: #fff; }
    .leaderboard-rank.other { background: var(--bg-card); color: var(--text-secondary); }
    .leaderboard-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: 600; color: #fff; }
    .leaderboard-info { flex: 1; }
    .leaderboard-name { font-weight: 600; }
    .leaderboard-lifetime { font-size: 0.75rem; color: var(--text-muted); }
    .leaderboard-points { font-weight: 700; color: var(--warning); font-size: 1.1rem; }
    .leaderboard-achievements { display: flex; gap: 4px; margin-left: 8px; }
    .mini-achievement { font-size: 1rem; }
    .prizes-list, .achievements-list, .users-list, .history-list { display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; }
    .prize-item, .achievement-item, .user-item, .history-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-elevated); border-radius: 8px; }
    .prize-icon, .achievement-icon { font-size: 1.5rem; }
    .prize-info, .achievement-info, .user-info { flex: 1; }
    .prize-name, .achievement-name, .user-name { font-weight: 600; font-size: 0.9rem; }
    .prize-desc, .achievement-desc { font-size: 0.75rem; color: var(--text-muted); }
    .prize-cost { font-weight: 700; color: var(--warning); }
    .achievement-threshold { font-size: 0.7rem; color: var(--accent); }
    .user-points { font-weight: 600; color: var(--warning); }
    .add-user-form, .add-prize-form, .add-achievement-form { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
    .quick-actions { display: flex; flex-direction: column; gap: 8px; }
    .action-select { width: 100%; }
    .action-btns { display: flex; gap: 8px; }
    .action-btns .btn { flex: 1; }
    .history-item { font-size: 0.85rem; }
    .history-amount { font-weight: 600; }
    .history-amount.positive { color: var(--success); }
    .history-amount.negative { color: var(--error); }
    .history-reason { color: var(--text-muted); font-size: 0.75rem; }
    .history-time { font-size: 0.7rem; color: var(--text-muted); margin-left: auto; }
    .empty-state { text-align: center; padding: 20px; color: var(--text-muted); font-size: 0.85rem; }

    @media (max-width: 1200px) {
      .points-container { grid-template-columns: 1fr; }
      .points-sidebar { display: grid; grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .points-grid { grid-template-columns: 1fr; }
      .points-sidebar { grid-template-columns: 1fr; }
    }

    @media (max-width: 1200px) {
      .three-col-layout { grid-template-columns: 1fr 1fr; }
      .three-col-layout .col-1 { grid-column: 1 / -1; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    }
    @media (max-width: 1024px) {
      .calendar-container { grid-template-columns: 1fr; }
      .calendar-sidebar { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    }
    @media (max-width: 900px) {
      .three-col-layout { grid-template-columns: 1fr; }
      .three-col-layout .col-1 { grid-column: 1; display: flex; flex-direction: column; }
    }
    
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .app-container { margin-left: 0; }
      .header { padding: 12px 16px; }
      .header-actions { display: none; }
      .mobile-menu-btn { display: block; }
      .tabs-container { padding: 0 16px; }
      .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .tab { padding: 12px 14px; font-size: 0.85rem; }
      .main { padding: 16px; }
      .three-col-layout { grid-template-columns: 1fr; gap: 16px; }
      .three-col-layout .col-1 { display: flex; flex-direction: column; gap: 16px; }
      .notes-grid, .lists-container { grid-template-columns: 1fr; }
      .form-row { flex-direction: column; }
      .add-item-form, .add-task-form { flex-direction: column; }
      .add-item-form .btn, .add-task-form .btn { width: 100%; justify-content: center; }
      .task-item.depth-1 { margin-left: 14px; }
      .task-item.depth-2 { margin-left: 28px; }
      .task-item.depth-3 { margin-left: 42px; }
      .kanban-board { flex-direction: column !important; }
      .kanban-column { min-width: auto !important; }
      .calendar-day { min-height: 50px; padding: 4px; }
      .day-events { display: none; }
      .calendar-day.has-events::after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background: var(--accent); border-radius: 50%; }
    }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
  </style>
</head>
<body>

<div class="mobile-overlay" id="mobile-overlay" onclick="toggleMobileMenu()"></div>
<div class="mobile-menu" id="mobile-menu">
  <div class="mobile-menu-header">
    <div class="logo-area">
      <img src="logo.png" alt="JotTick">
      <span>JotTick</span>
    </div>
    <button class="mobile-menu-close" onclick="toggleMobileMenu()">‚úï</button>
  </div>
  <nav class="mobile-menu-nav">
    <div class="mobile-nav-section">Demo Navigation</div>
    <a href="#" class="mobile-nav-item active" onclick="switchTabMobile('notes')">üìù Notes</a>
    <a href="#" class="mobile-nav-item" onclick="switchTabMobile('lists')">‚òëÔ∏è Checklists</a>
    <a href="#" class="mobile-nav-item" onclick="switchTabMobile('tasks')">üìã Tasks</a>
    <a href="#" class="mobile-nav-item" onclick="switchTabMobile('kanban')">üìä Kanban</a>
    <a href="#" class="mobile-nav-item" onclick="switchTabMobile('calendar')">üìÖ Calendar</a>
    <a href="#" class="mobile-nav-item" onclick="switchTabMobile('points')">‚≠ê Points</a>
    <div class="mobile-nav-divider"></div>
    <div class="mobile-nav-section">Links</div>
    <a href="https://github.com/gelatinescreams/JotTick" target="_blank" class="mobile-nav-item">‚≠ê GitHub Repository</a>
    <a href="https://github.com/gelatinescreams/JotTick#installation" target="_blank" class="mobile-nav-item">üì• Installation Guide</a>
    <a href="https://github.com/gelatinescreams/JotTick/blob/main/README.md" target="_blank" class="mobile-nav-item">üìñ Documentation</a>
    <a href="https://hacs.xyz/" target="_blank" class="mobile-nav-item">üè† HACS</a>
    <div class="mobile-nav-divider"></div>
    <div class="mobile-nav-section">Home Assistant (Demo)</div>
    <a href="#" class="mobile-nav-item" onclick="toggleMobileMenu()">üè† Overview</a>
    <a href="#" class="mobile-nav-item" onclick="toggleMobileMenu()">‚ö° Energy</a>
    <a href="#" class="mobile-nav-item" onclick="toggleMobileMenu()">üìä History</a>
    <a href="#" class="mobile-nav-item" onclick="toggleMobileMenu()">‚öôÔ∏è Settings</a>
  </nav>
  <div class="mobile-menu-footer">
    <button class="reset-btn" onclick="location.reload()">üîÑ Reset Demo</button>
  </div>
</div>

<aside class="sidebar">
  <div class="sidebar-header">
    <svg class="ha-logo" viewBox="0 0 240 240">
      <path fill="#18BCF2" d="M240 224.762c0 8.416-6.822 15.238-15.238 15.238H15.238C6.822 240 0 233.178 0 224.762V15.238C0 6.822 6.822 0 15.238 0h209.524C233.178 0 240 6.822 240 15.238v209.524z"/>
      <path fill="#fff" d="M120 40L40 120h50v80h60v-80h50L120 40z"/>
    </svg>
    <span class="ha-title">Home Assistant</span>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-item"><span class="nav-icon">üè†</span><span class="nav-label">Overview</span></div>
    <div class="nav-item"><span class="nav-icon">‚ö°</span><span class="nav-label">Energy</span></div>
    <div class="nav-item"><span class="nav-icon">üó∫Ô∏è</span><span class="nav-label">Map</span></div>
    <div class="nav-item"><span class="nav-icon">üìñ</span><span class="nav-label">Logbook</span></div>
    <div class="nav-item"><span class="nav-icon">üìä</span><span class="nav-label">History</span></div>
    <div class="nav-divider"></div>
    <div class="nav-item active"><span class="nav-icon">üìù</span><span class="nav-label">JotTick</span></div>
    <div class="nav-item"><span class="nav-icon">üì∫</span><span class="nav-label">Media</span></div>
    <div class="nav-item"><span class="nav-icon">üõí</span><span class="nav-label">Shopping List</span></div>
    <div class="nav-divider"></div>
    <div class="nav-item"><span class="nav-icon">üõ†Ô∏è</span><span class="nav-label">Developer Tools</span></div>
    <div class="nav-item"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-label">Settings</span></div>
  </nav>
  <div class="sidebar-footer">
    <div class="user-avatar">D</div>
    <span class="user-name">Demo User</span>
  </div>
</aside>

<div class="app-container">
  <header class="header">
    <div class="header-left">
      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
      <div class="header-title">
        <img src="logo.png" alt="JotTick">
        JotTick
      </div>
      <span class="demo-badge">JUST A DEMO! ONLY FOR USING FUNTIONS. NOT FINAL THEME</span>
    </div>
    <div class="header-actions">
      <a href="https://github.com/gelatinescreams/JotTick" target="_blank" class="header-btn">‚≠ê GitHub</a>
      <button class="header-btn" onclick="location.reload()">üîÑ Reset Demo</button>
    </div>
  </header>

  <div class="tabs-container">
    <div class="tabs">
      <button class="tab active" data-tab="notes"><span class="tab-icon">üìù</span>Notes<span class="tab-count" id="notes-count">0</span></button>
      <button class="tab" data-tab="lists"><span class="tab-icon">‚òëÔ∏è</span>Checklists<span class="tab-count" id="lists-count">0</span></button>
      <button class="tab" data-tab="tasks"><span class="tab-icon">üìã</span>Tasks<span class="tab-count" id="tasks-count">0</span></button>
      <button class="tab" data-tab="kanban"><span class="tab-icon">üìä</span>Kanban</button>
      <button class="tab" data-tab="calendar"><span class="tab-icon">üìÖ</span>Calendar</button>
      <button class="tab" data-tab="points"><span class="tab-icon">‚≠ê</span>Points</button>
    </div>
  </div>

  <main class="main">
    <div class="tab-content active" id="notes-tab">
      <div class="create-form">
        <div class="form-title">Create New Note</div>
        <div class="form-row"><input type="text" id="note-title" placeholder="Note title..."></div>
        <div class="options-row">
          <div class="toggle-group">
            <button class="toggle-btn active" data-format="html">HTML</button>
            <button class="toggle-btn" data-format="md">Markdown</button>
          </div>
          <div class="option-group"><label><input type="checkbox" id="note-lock-toggle">üîí Password protect</label></div>
        </div>
        <div class="password-field" id="password-field"><input type="password" id="note-password" placeholder="Enter password to lock note..."></div>
        <div class="form-row"><textarea id="note-content" placeholder="Write your note content here..."></textarea></div>
        <div class="image-preview" id="note-images"></div>
        <div class="form-row">
          <label class="file-label"><span>üì∑</span> Add Images<input type="file" id="note-image-input" accept="image/*" multiple></label>
          <button class="btn" onclick="createNote()">Create Note</button>
        </div>
		
      </div>
	  
      <div class="notes-grid" id="notes-container"></div>
	  <div class="assist-config">
  <h3>üéôÔ∏è Assist Reminder Settings</h3>
  <p class="help">Say "Remind me to..." or "Remind [name] to..." and notifications go to the right phone!</p>
  
  <div class="assist-section">
    <div class="assist-section-title">My Device (for "Remind Me")</div>
    <select id="user-select">
      <option value="">-- Select your HA user --</option>
      <option value="user1">Dad</option>
      <option value="user2">Mom</option>
      <option value="user3">Kids</option>
    </select>
    <select id="user-device-select">
      <option value="">-- Select device --</option>
      <option value="notify.mobile_app_dads_phone">Dad's Phone</option>
      <option value="notify.mobile_app_moms_phone">Mom's Phone</option>
      <option value="notify.mobile_app_tablet">Kitchen Tablet</option>
    </select>
    <button class="btn btn-sm" onclick="saveUserDevice()">Save My Device</button>
    <div id="user-devices-list"></div>
  </div>
  
  <div class="assist-section">
    <div class="assist-section-title">Name Aliases (for "Remind Mom/Tim/Dad")</div>
    <input type="text" id="alias-names" placeholder="Names separated by commas (e.g. tim, timmy, dad)">
    <select id="alias-device-select">
      <option value="">-- Select device --</option>
      <option value="notify.mobile_app_dads_phone">Dad's Phone</option>
      <option value="notify.mobile_app_moms_phone">Mom's Phone</option>
      <option value="notify.mobile_app_tablet">Kitchen Tablet</option>
    </select>
    <button class="btn btn-sm" onclick="saveAlias()">Save Alias</button>
    <div id="aliases-list"></div>
  </div>
  
  <div class="assist-section">
    <div class="assist-section-title">Pending Assist Reminders</div>
    <div id="pending-reminders"></div>
  </div>
  
  <div class="assist-status" id="assist-status"></div>
</div>
    </div>

    <div class="tab-content" id="lists-tab">
      <div class="create-form">
        <div class="form-title">Create New Checklist</div>
        <div class="form-row">
          <input type="text" id="list-title" placeholder="Checklist title...">
          <button class="btn" onclick="createList()">Create Checklist</button>
        </div>
        <div class="form-row" style="margin-top:8px;">
          <label class="toggle-label" style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="hide-completed-lists" onchange="toggleHideCompletedLists()" style="width:18px;height:18px;accent-color:var(--accent);">
            <span style="font-size:0.85rem;color:var(--text-secondary);">Hide Completed Items</span>
          </label>
        </div>
      </div>
      <div class="lists-container" id="lists-container"></div>
    </div>

    <div class="tab-content" id="tasks-tab">
      <div class="create-form">
        <div class="form-title">Create New Task List</div>
        <div class="form-row">
          <input type="text" id="task-list-title" placeholder="Task list title...">
          <button class="btn" onclick="createTaskList()">Create Task List</button>
        </div>
        <div class="form-row" style="margin-top:8px;">
          <label class="toggle-label" style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="hide-completed-tasks" onchange="toggleHideCompletedTasks()" style="width:18px;height:18px;accent-color:var(--accent);">
            <span style="font-size:0.85rem;color:var(--text-secondary);">Hide Completed Items</span>
          </label>
        </div>
      </div>
      <div id="tasks-container"></div>
    </div>

    <div class="tab-content" id="kanban-tab">
      <div class="kanban-hint" id="kanban-hint">üí° <strong>Tip:</strong> Hold and drag items to move between columns</div>
      <div class="kanban-container" id="kanban-container"></div>
    </div>

    <div class="tab-content" id="calendar-tab">
      <div id="overdue-banner-container"></div>
      <div class="calendar-container">
        <div class="calendar-main">
          <div class="calendar-header">
            <div class="calendar-nav">
              <button class="calendar-nav-btn" onclick="changeMonth(-1)">‚óÄ</button>
              <span class="calendar-month-title" id="calendar-month-title">December 2025</span>
              <button class="calendar-nav-btn" onclick="changeMonth(1)">‚ñ∂</button>
              <button class="btn btn-sm btn-secondary" onclick="goToToday()" style="margin-left:8px;">Today</button>
            </div>
            <button class="btn btn-sm btn-secondary" onclick="toggleCalendarSettings()">‚öôÔ∏è Settings</button>
          </div>
          <div class="calendar-grid" id="calendar-grid"></div>
        </div>
        
        <div class="calendar-sidebar">
          <div class="calendar-panel">
            <div class="calendar-panel-title">üìÖ Upcoming Events</div>
            <div class="upcoming-events" id="upcoming-events"></div>
          </div>
          
          <div class="calendar-panel">
            <div class="calendar-panel-title">üì• iCal Import</div>
            <div class="ical-input-group">
              <label>Calendar URL (.ics)</label>
              <input type="url" id="ical-url" placeholder="https://calendar.google.com/...">
            </div>
            <div class="ical-input-group">
              <label>Calendar Name</label>
              <input type="text" id="ical-name" placeholder="Work Calendar">
            </div>
            <button class="btn btn-sm" onclick="importIcal()" style="width:100%;">Import Calendar</button>
            <div class="ical-sources" id="ical-sources"></div>
          </div>
          
          <div class="calendar-panel">
            <div class="calendar-panel-title">üé® Event Colors</div>
            <div class="color-settings" id="color-settings"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="points-tab">
      <div class="points-container">
        <div class="points-grid">
          <div class="points-card leaderboard-card">
            <div class="points-card-header">
              <h3>üèÜ Leaderboard</h3>
            </div>
            <div class="leaderboard-list" id="leaderboard-list"></div>
          </div>

          <div class="points-card">
            <div class="points-card-header">
              <h3>üéÅ Prize Store</h3>
              <button class="btn btn-sm" onclick="toggleAddPrize()">+ Add Prize</button>
            </div>
            <div class="add-prize-form" id="add-prize-form" style="display:none;">
              <input type="text" id="prize-name" placeholder="Prize name">
              <input type="number" id="prize-cost" placeholder="Cost in points" min="1" value="100">
              <textarea id="prize-desc" placeholder="Description (optional)"></textarea>
              <button class="btn btn-sm" onclick="addPrize()">Create Prize</button>
            </div>
            <div class="prizes-list" id="prizes-list"></div>
          </div>

          <div class="points-card">
            <div class="points-card-header">
              <h3>üèÖ Achievements</h3>
              <button class="btn btn-sm" onclick="toggleAddAchievement()">+ Add Achievement</button>
            </div>
            <div class="add-achievement-form" id="add-achievement-form" style="display:none;">
              <input type="text" id="ach-name" placeholder="Achievement name">
              <input type="text" id="ach-desc" placeholder="Description">
              <input type="number" id="ach-threshold" placeholder="Auto at lifetime points (0=manual)" min="0" value="0">
              <button class="btn btn-sm" onclick="addAchievement()">Create Achievement</button>
            </div>
            <div class="achievements-list" id="achievements-list"></div>
          </div>

          <div class="points-card history-card">
            <div class="points-card-header">
              <h3>üìú Recent History</h3>
            </div>
            <div class="history-list" id="history-list"></div>
          </div>
        </div>

        <div class="points-sidebar">
          <div class="points-card">
            <div class="points-card-header">
              <h3>üë• Manage Users</h3>
            </div>
            <div class="add-user-form">
              <input type="text" id="new-user-name" placeholder="New user name">
              <button class="btn btn-sm" onclick="addPointsUser()">Add User</button>
            </div>
            <div class="users-list" id="users-list"></div>
          </div>

          <div class="points-card">
            <div class="points-card-header">
              <h3>‚ö° Quick Actions</h3>
            </div>
            <div class="quick-actions">
              <select id="action-user" class="action-select">
                <option value="">Select user...</option>
              </select>
              <input type="number" id="action-points" placeholder="Points" value="10">
              <input type="text" id="action-reason" placeholder="Reason (optional)">
              <div class="action-btns">
                <button class="btn btn-sm btn-success" onclick="quickAddPoints()">+ Add</button>
                <button class="btn btn-sm btn-danger" onclick="quickRemovePoints()">- Remove</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<div class="modal-overlay" id="image-modal" onclick="closeImageModal()">
  <button class="modal-close" onclick="closeImageModal()">√ó</button>
  <img src="" alt="" class="modal-image" id="modal-image" onclick="event.stopPropagation()">
</div>

<div class="toast" id="toast"></div>

<script>
let notes = [];
let lists = [];
let taskLists = [];
let noteImages = [];
let currentFormat = 'html';
let scheduledNotes = {};
let listRecurring = {};
let listReminders = {};
let taskReminders = {};
let itemRecurring = {};
let hideCompletedLists = false;
let hideCompletedTasks = false;
let voiceNoteId = null;
let voiceNoteTimeout = null;
let voiceCountdownInterval = null;
let currentDate = new Date();
let calendarEvents = [];
let icalSources = [];
let eventColors = {
  'note-created': '#3b82f6',
  'note-edited': '#f59e0b',
  'list-due': '#10b981',
  'task-due': '#F9E900',
  'task-overdue': '#ef4444',
  'imported': '#A855F7'
};

// Points System Data
let pointsUsers = {};
let pointsPrizes = [];
let pointsAchievements = [];
let pointsHistory = [];
let userAchievements = {};

function toggleMobileMenu() {
  document.getElementById('mobile-menu').classList.toggle('show');
  document.getElementById('mobile-overlay').classList.toggle('show');
  document.body.style.overflow = document.getElementById('mobile-menu').classList.contains('show') ? 'hidden' : '';
}

function switchTabMobile(tabName) {
  toggleMobileMenu();
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
  document.getElementById(tabName + '-tab').classList.add('active');
  document.querySelectorAll('.mobile-nav-item').forEach(item => {
    if (item.textContent.toLowerCase().includes(tabName.replace('s',''))) {
      item.classList.add('active');
    } else if (!item.href.includes('github') && !item.href.includes('hacs')) {
      item.classList.remove('active');
    }
  });
}

const devices = [
  { id: 'mobile_app_phone', name: "Dad's Phone" },
  { id: 'mobile_app_phone_2', name: "Mom's Phone" },
  { id: 'mobile_app_tablet', name: 'Kitchen Tablet' },
  { id: 'mobile_app_kids', name: "Kids' Tablet" }
];

const timePresets = [
  { value: '06:00', label: '6:00 AM' },
  { value: '08:00', label: '8:00 AM' },
  { value: '09:00', label: '9:00 AM' },
  { value: '12:00', label: '12:00 PM' },
  { value: '18:00', label: '6:00 PM' },
  { value: '21:00', label: '9:00 PM' },
  { value: '06:00,18:00', label: '6 AM & 6 PM' },
  { value: '08:00,20:00', label: '8 AM & 8 PM' },
  { value: '06:00,12:00,18:00', label: '6 AM, 12 PM, 6 PM' }
];

document.addEventListener('DOMContentLoaded', () => {
  initTabs();
  initFormatToggle();
  initLockToggle();
  initImageUpload();
  loadSampleData();
  createVoiceNote();
  renderAll();
});

function initTabs() {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
    });
  });
}

function initFormatToggle() {
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFormat = btn.dataset.format;
      document.getElementById('note-content').placeholder = currentFormat === 'md' 
        ? 'Write in **Markdown**...\n\n# Heading\n- List item\n> Quote'
        : 'Write your note content here...';
    });
  });
}

function initLockToggle() {
  document.getElementById('note-lock-toggle').addEventListener('change', (e) => {
    document.getElementById('password-field').classList.toggle('show', e.target.checked);
  });
}

function initImageUpload() {
  document.getElementById('note-image-input').addEventListener('change', (e) => {
    Array.from(e.target.files).forEach(file => {
      const reader = new FileReader();
      reader.onload = (ev) => {
        noteImages.push({ name: file.name, data: ev.target.result });
        renderImagePreviews();
      };
      reader.readAsDataURL(file);
    });
    e.target.value = '';
  });
}

function renderImagePreviews() {
  document.getElementById('note-images').innerHTML = noteImages.map((img, i) => `
    <div class="preview-thumb">
      <img src="${img.data}" alt="${img.name}">
      <button class="preview-remove" onclick="removePreviewImage(${i})">√ó</button>
    </div>
  `).join('');
}

function removePreviewImage(index) {
  noteImages.splice(index, 1);
  renderImagePreviews();
}

function createVoiceNote() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
  const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  
  voiceNoteId = 'voice-' + generateId();
  const voiceNote = {
    id: voiceNoteId,
    title: 'Home Assist Voice Note',
    content: `<strong>Voice reminder received at ${timeStr}</strong><br><br>"Hey Lambert, remind me to check the demo features in 5 minutes."<br><br>This note was created via <strong>Assist</strong>. It will auto delete in 5 minutes, simulating how JotTick handles temporary voice notes.`,
    format: 'html',
    images: [],
    locked: false,
    isVoice: true,
    created: now.toISOString(),
    expiresAt: new Date(now.getTime() + 5 * 60 * 1000).toISOString()
  };
  
  notes.unshift(voiceNote);
  
  scheduledNotes[voiceNoteId] = [
    { devices: ['mobile_app_tablet'], time: new Date(now.getTime() + 5 * 60 * 1000).toISOString(), id: generateId() }
  ];
  
  voiceNoteTimeout = setTimeout(() => {
    notes = notes.filter(n => n.id !== voiceNoteId);
    delete scheduledNotes[voiceNoteId];
    voiceNoteId = null;
    renderNotes();
    showToast('Voice note expired and deleted');
  }, 5 * 60 * 1000);
  
  voiceCountdownInterval = setInterval(updateVoiceCountdown, 1000);
}

function updateVoiceCountdown() {
  const voiceNote = notes.find(n => n.id === voiceNoteId);
  if (!voiceNote) {
    clearInterval(voiceCountdownInterval);
    return;
  }
  
  const now = new Date();
  const expires = new Date(voiceNote.expiresAt);
  const remaining = Math.max(0, Math.floor((expires - now) / 1000));
  
  const mins = Math.floor(remaining / 60);
  const secs = remaining % 60;
  
  const countdownEl = document.getElementById('voice-countdown');
  if (countdownEl) {
    countdownEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
  }
  
  if (remaining <= 0) {
    clearInterval(voiceCountdownInterval);
  }
}

function loadSampleData() {
  const id1 = generateId();
  const id2 = generateId();
  const id3 = generateId();
  const id4 = generateId();
  
  notes = notes.concat([
    { id: id1, title: 'Welcome to JotTick for Home Assistant! üëã', content: 'JotTick is an integration for Home Assistant. This is an interactive demo. Try the <strong>Send</strong> button to see device selection and scheduling!', format: 'html', images: [], locked: false, created: new Date(Date.now() - 3600000).toISOString() },
    { id: id2, title: 'Looking for JotTick without Home Assistant?', content: 'Looking for a standalone version of JotTick without needing Home Assistant? Its right here <a target="_blank" style="color:var(--accent)" href="https://jotty.page/">https://jotty.page/</a> and its the inspiration for this one! Want a Jotty integration with Home Assistant? <a target="_blank" style="color:var(--accent)" href="https://jotty.page/">Check out that integration here</a>. Otherwise, enjoy JotTick :)', format: 'md', images: [], locked: false, created: new Date(Date.now() - 7200000).toISOString() },	
    { id: id3, title: 'Markdown Example', content: '# Heading 1\n\nThis note uses **markdown** formatting.\n\n## Features\n- Bold with `**text**`\n- *Italic* with `*text*`\n\n> Blockquotes work too!', format: 'md', images: [], locked: false, created: new Date(Date.now() - 7200000).toISOString() },
    { id: id4, title: 'Password Protected üîí', content: 'Secret content revealed!', format: 'html', images: [], locked: true, password: 'demo', created: new Date(Date.now() - 10800000).toISOString() }
  ]);
  
  scheduledNotes[id1] = [
    { devices: ['mobile_app_phone'], time: new Date(Date.now() + 3600000).toISOString(), id: generateId() }
  ];

  const listId1 = generateId();
  const listId2 = generateId();
  
  lists = [
    { id: listId1, title: 'Grocery List', items: [{ text: 'Milk', completed: true }, { text: 'Eggs', completed: true }, { text: 'Bread', completed: false }, { text: 'Coffee', completed: false }] },
    { id: listId2, title: 'Daily Routine', items: [{ text: 'Morning workout', completed: true }, { text: 'Check emails', completed: false }, { text: 'Team standup', completed: false }] }
  ];
  
  listRecurring[listId2] = { days: ['mon','tue','wed','thu','fri'], times: '06:00' };
  listReminders[listId1] = { devices: ['mobile_app_phone'], interval: '4h', start: '09:00', end: '21:00' };

  const taskId1 = generateId();
  const taskId2 = generateId();
  taskLists = [
    { id: taskId1, title: 'Home Assistant Project', statuses: [
      { id: 'todo', label: 'To Do', color: '#6b7280', order: 0 },
      { id: 'in_progress', label: 'In Progress', color: '#3b82f6', order: 1 },
      { id: 'completed', label: 'Completed', color: '#10b981', order: 2 }
    ], items: [
      { id: generateId(), text: 'Install JotTick', status: 'completed', depth: 0 },
      { id: generateId(), text: 'Configure automations', status: 'in_progress', depth: 0 },
      { id: generateId(), text: 'Set up recurring resets', status: 'todo', depth: 1 },
      { id: generateId(), text: 'Configure reminders', status: 'todo', depth: 1 },
      { id: generateId(), text: 'Create dashboard', status: 'todo', depth: 0 }
    ]},
    { id: taskId2, title: 'Weekend Chores', statuses: [
      { id: 'todo', label: 'To Do', color: '#6b7280', order: 0 },
      { id: 'doing', label: 'Doing', color: '#f59e0b', order: 1 },
      { id: 'done', label: 'Done', color: '#22c55e', order: 2 }
    ], items: [
      { id: generateId(), text: 'Mow the lawn', status: 'todo', depth: 0 },
      { id: generateId(), text: 'Clean garage', status: 'doing', depth: 0 },
      { id: generateId(), text: 'Grocery shopping', status: 'done', depth: 0 }
    ]}
  ];
  
  taskReminders[taskId1] = { devices: ['mobile_app_phone', 'mobile_app_tablet'], interval: '2h', start: '08:00', end: '20:00' };

  // Points sample data
  const uid1 = generateId();
  const uid2 = generateId();
  const uid3 = generateId();
  pointsUsers = {
    [uid1]: { name: 'Emma', points: 245, lifetime_points: 520 },
    [uid2]: { name: 'Jack', points: 180, lifetime_points: 380 },
    [uid3]: { name: 'Sophie', points: 95, lifetime_points: 195 }
  };

  pointsPrizes = [
    { id: generateId(), name: 'Extra Screen Time', cost: 50, description: '30 minutes extra tablet time' },
    { id: generateId(), name: 'Choose Dinner', cost: 100, description: 'Pick what the family has for dinner' },
    { id: generateId(), name: 'Movie Night Pick', cost: 150, description: 'Choose the family movie' },
    { id: generateId(), name: 'New Toy/Game', cost: 500, description: 'Pick a new toy or game up to $20' }
  ];

  pointsAchievements = [
    { id: generateId(), name: 'First Steps', description: 'Earn your first 10 points', points_threshold: 10 },
    { id: generateId(), name: 'Rising Star', description: 'Reach 100 lifetime points', points_threshold: 100 },
    { id: generateId(), name: 'Point Master', description: 'Reach 500 lifetime points', points_threshold: 500 },
    { id: generateId(), name: 'Champion', description: 'Reach 1000 lifetime points', points_threshold: 1000 }
  ];

  userAchievements = {
    [uid1]: [pointsAchievements[0].id, pointsAchievements[1].id, pointsAchievements[2].id],
    [uid2]: [pointsAchievements[0].id, pointsAchievements[1].id],
    [uid3]: [pointsAchievements[0].id, pointsAchievements[1].id]
  };

  pointsHistory = [
    { id: generateId(), user_id: uid1, user_name: 'Emma', amount: 15, reason: 'Completed homework', timestamp: new Date(Date.now() - 3600000).toISOString() },
    { id: generateId(), user_id: uid2, user_name: 'Jack', amount: 10, reason: 'Made bed', timestamp: new Date(Date.now() - 7200000).toISOString() },
    { id: generateId(), user_id: uid3, user_name: 'Sophie', amount: 20, reason: 'Helped with dishes', timestamp: new Date(Date.now() - 10800000).toISOString() },
    { id: generateId(), user_id: uid1, user_name: 'Emma', amount: -50, reason: 'Redeemed: Extra Screen Time', timestamp: new Date(Date.now() - 14400000).toISOString() }
  ];
}

function createNote() {
  const title = document.getElementById('note-title').value.trim();
  const content = document.getElementById('note-content').value;
  const lockEnabled = document.getElementById('note-lock-toggle').checked;
  const password = document.getElementById('note-password').value;
  if (!title) { showToast('Please enter a title'); return; }
  if (lockEnabled && !password) { showToast('Please enter a password'); return; }
  notes.unshift({ id: generateId(), title, content, format: currentFormat, images: [...noteImages], locked: lockEnabled, password: lockEnabled ? password : null, unlocked: false, created: new Date().toISOString() });
  document.getElementById('note-title').value = '';
  document.getElementById('note-content').value = '';
  document.getElementById('note-lock-toggle').checked = false;
  document.getElementById('note-password').value = '';
  document.getElementById('password-field').classList.remove('show');
  noteImages = [];
  renderImagePreviews();
  renderNotes();
  showToast('Note created!');
}

function deleteNote(id) {
  if (confirm('Delete this note?')) {
    if (id === voiceNoteId) {
      clearTimeout(voiceNoteTimeout);
      clearInterval(voiceCountdownInterval);
      voiceNoteId = null;
    }
    notes = notes.filter(n => n.id !== id);
    delete scheduledNotes[id];
    renderNotes();
    showToast('Note deleted');
  }
}

function unlockNote(id) {
  const note = notes.find(n => n.id === id);
  const input = document.getElementById(`unlock-${id}`);
  if (input.value === note.password) {
    note.unlocked = true;
    renderNotes();
    showToast('Note unlocked!');
  } else {
    showToast('Wrong password');
    input.value = '';
  }
}

function toggleSendPanel(noteId) {
  const panel = document.getElementById(`send-panel-${noteId}`);
  panel.classList.toggle('show');
}

function setSendMode(noteId, mode) {
  document.querySelectorAll(`#send-panel-${noteId} .mode-tab`).forEach(t => t.classList.remove('active'));
  document.querySelector(`#send-panel-${noteId} .mode-tab[data-mode="${mode}"]`).classList.add('active');
  document.getElementById(`schedule-section-${noteId}`).classList.toggle('show', mode === 'schedule');
}

function sendNoteNow(noteId) {
  const panel = document.getElementById(`send-panel-${noteId}`);
  const checked = panel.querySelectorAll('.device-cb:checked');
  if (checked.length === 0) { showToast('Select at least one device'); return; }
  const deviceNames = Array.from(checked).map(cb => devices.find(d => d.id === cb.value).name);
  showToast(`Sent to ${deviceNames.join(', ')}!`);
  panel.classList.remove('show');
}

function scheduleNote(noteId) {
  const panel = document.getElementById(`send-panel-${noteId}`);
  const checked = panel.querySelectorAll('.device-cb:checked');
  const datetime = document.getElementById(`schedule-time-${noteId}`).value;
  if (checked.length === 0) { showToast('Select at least one device'); return; }
  if (!datetime) { showToast('Select a date and time'); return; }
  if (!scheduledNotes[noteId]) scheduledNotes[noteId] = [];
  scheduledNotes[noteId].push({ devices: Array.from(checked).map(cb => cb.value), time: new Date(datetime).toISOString(), id: generateId() });
  showToast('Scheduled!');
  renderNotes();
}

function cancelSchedule(noteId, scheduleId) {
  scheduledNotes[noteId] = scheduledNotes[noteId].filter(s => s.id !== scheduleId);
  if (scheduledNotes[noteId].length === 0) delete scheduledNotes[noteId];
  renderNotes();
  showToast('Schedule cancelled');
}

function renderNotes() {
  const container = document.getElementById('notes-container');
  document.getElementById('notes-count').textContent = notes.length;
  if (notes.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">üìù</div><div class="empty-text">No notes yet</div><div class="empty-hint">Create your first note above</div></div>`;
    return;
  }
  container.innerHTML = notes.map(note => {
    const schedules = scheduledNotes[note.id] || [];
    const scheduleCount = schedules.length;
    const isVoice = note.isVoice;
    
    if (note.locked && !note.unlocked) {
      return `<div class="note-card">
        <div class="note-header"><div class="note-title">${escapeHtml(note.title)}</div><div class="note-badges"><span class="badge badge-locked">üîíLocked</span></div></div>
        <div class="locked-overlay"><div class="locked-icon">üîê</div><div class="locked-text">Password protected<br><small style="color:var(--text-muted)">(hint: demo)</small></div>
        <div class="unlock-form"><input type="password" id="unlock-${note.id}" placeholder="Enter password..."><button class="btn btn-sm" onclick="unlockNote('${note.id}')">Unlock</button></div></div>
        <div class="note-actions"><button class="btn btn-sm btn-danger" onclick="deleteNote('${note.id}')">Delete</button></div>
      </div>`;
    }
    
    const contentHtml = note.format === 'md' ? `<div class="note-content markdown">${renderMarkdown(note.content)}</div>` : `<div class="note-content">${note.content.replace(/\n/g, '<br>')}</div>`;
    const imagesHtml = note.images.length > 0 ? `<div class="note-images">${note.images.map(img => `<div class="note-image" onclick="openImageModal('${img.data}')"><img src="${img.data}"></div>`).join('')}</div>` : '';
    
    const voiceIndicator = isVoice ? `
      <div class="voice-indicator">
        <span class="voice-icon">üéôÔ∏è</span>
        <span class="voice-text">Voice note ‚Ä¢ Auto-deletes in <span class="voice-countdown" id="voice-countdown">5:00</span></span>
      </div>
    ` : '';
    
    return `<div class="note-card ${isVoice ? 'voice-note' : ''}">
      <div class="note-header">
        <div class="note-title">${escapeHtml(note.title)}</div>
        <div class="note-badges">
          ${isVoice ? '<span class="badge badge-voice">üéôÔ∏è Voice</span>' : ''}
          ${note.format === 'md' ? '<span class="badge badge-md">MD</span>' : ''}
          ${note.locked ? '<span class="badge badge-locked">üîì</span>' : ''}
        </div>
      </div>
      ${voiceIndicator}
      ${contentHtml}
      ${imagesHtml}
      <div class="note-timestamp">${formatDate(note.created)}</div>
      <div class="note-actions">
        <div class="btn-wrapper">
          <button class="btn btn-sm btn-secondary" onclick="toggleSendPanel('${note.id}')">üì§ Send</button>
          ${scheduleCount > 0 ? `<span class="btn-badge">${scheduleCount}</span>` : ''}
        </div>
        <button class="btn btn-sm btn-danger" onclick="deleteNote('${note.id}')">Delete</button>
      </div>
      <div class="panel panel-send" id="send-panel-${note.id}">
        <div class="panel-title">üì§ Send Note</div>
        <div class="panel-devices">${devices.map(d => `<label class="device-check"><input type="checkbox" class="device-cb" value="${d.id}">${d.name}</label>`).join('')}</div>
        <div class="mode-tabs">
          <button class="mode-tab active" data-mode="now" onclick="setSendMode('${note.id}','now')">Send Now</button>
          <button class="mode-tab" data-mode="schedule" onclick="setSendMode('${note.id}','schedule')">Schedule</button>
        </div>
        <div class="schedule-section" id="schedule-section-${note.id}">
          <div class="panel-row"><label class="panel-label">When:</label><input type="datetime-local" id="schedule-time-${note.id}" style="flex:1;"></div>
        </div>
        <div class="panel-actions">
          <button class="btn btn-sm" onclick="sendNoteNow('${note.id}')">Send Now</button>
          <button class="btn btn-sm btn-secondary" onclick="scheduleNote('${note.id}')" id="schedule-btn-${note.id}" style="display:none;">Schedule</button>
        </div>
        ${schedules.length > 0 ? `<div class="pending-schedules"><div class="pending-title">üìÖ Pending Schedules</div>${schedules.map(s => `<div class="pending-item"><div><div class="pending-info">${s.devices.map(id => devices.find(d=>d.id===id)?.name || id).join(', ')}</div><div class="pending-time">${formatDate(s.time)}</div></div><button class="btn btn-sm btn-danger" onclick="cancelSchedule('${note.id}','${s.id}')">Cancel</button></div>`).join('')}</div>` : ''}
      </div>
    </div>`;
  }).join('');
  
  document.querySelectorAll('.mode-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const noteId = this.closest('.panel-send').id.replace('send-panel-', '');
      const scheduleBtn = document.getElementById(`schedule-btn-${noteId}`);
      scheduleBtn.style.display = this.dataset.mode === 'schedule' ? 'inline-flex' : 'none';
    });
  });
  
  updateVoiceCountdown();
}

function createList() {
  const title = document.getElementById('list-title').value.trim();
  if (!title) { showToast('Please enter a title'); return; }
  lists.unshift({ id: generateId(), title, items: [] });
  document.getElementById('list-title').value = '';
  renderLists();
  showToast('Checklist created!');
}

function deleteList(id) {
  if (confirm('Delete this checklist?')) {
    const card = document.querySelector(`[data-list-id="${id}"]`);
    if (card) {
      card.classList.add('dissipating');
      setTimeout(() => {
        lists = lists.filter(l => l.id !== id);
        delete listRecurring[id];
        delete listReminders[id];
        renderLists();
        showToast('Checklist deleted');
      }, 400);
    } else {
      lists = lists.filter(l => l.id !== id);
      delete listRecurring[id];
      delete listReminders[id];
      renderLists();
      showToast('Checklist deleted');
    }
  }
}

function addListItem(listId) {
  const input = document.getElementById(`add-item-${listId}`);
  const text = input.value.trim();
  if (!text) return;
  lists.find(l => l.id === listId).items.push({ text, completed: false });
  input.value = '';
  renderLists();
}

function toggleItem(listId, itemIndex) {
  lists.find(l => l.id === listId).items[itemIndex].completed = !lists.find(l => l.id === listId).items[itemIndex].completed;
  renderLists();
}

function toggleHideCompletedLists() {
  hideCompletedLists = document.getElementById('hide-completed-lists').checked;
  renderLists();
}

function toggleHideCompletedTasks() {
  hideCompletedTasks = document.getElementById('hide-completed-tasks').checked;
  renderTasks();
  renderKanban();
}

function deleteListItem(listId, itemIndex) {
  lists.find(l => l.id === listId).items.splice(itemIndex, 1);
  renderLists();
}

function resetList(listId) {
  lists.find(l => l.id === listId).items.forEach(item => item.completed = false);
  renderLists();
  showToast('Checklist reset!');
}

function toggleRecurringPanel(listId) {
  document.getElementById(`recurring-panel-${listId}`).classList.toggle('show');
}

function toggleReminderPanel(listId) {
  document.getElementById(`reminder-panel-${listId}`).classList.toggle('show');
}

function toggleDay(listId, day) {
  const btn = document.querySelector(`#recurring-panel-${listId} .day-btn[data-day="${day}"]`);
  btn.classList.toggle('active');
}

function saveRecurring(listId) {
  const panel = document.getElementById(`recurring-panel-${listId}`);
  const days = Array.from(panel.querySelectorAll('.day-btn.active')).map(b => b.dataset.day);
  const times = panel.querySelector('.time-preset').value;
  if (days.length === 0) { showToast('Select at least one day'); return; }
  listRecurring[listId] = { days, times };
  showToast('Recurring reset saved!');
  renderLists();
}

function removeRecurring(listId) {
  delete listRecurring[listId];
  showToast('Recurring reset removed');
  renderLists();
}

function toggleItemRecurring(parentId, itemIndex, type) {
  const key = `${parentId}:${itemIndex}`;
  const popup = document.getElementById(`item-rec-popup-${parentId}-${itemIndex}`);
  popup.style.display = popup.style.display === 'none' ? 'block' : 'none';
}

function saveItemRecurring(parentId, itemIndex, type) {
  const key = `${parentId}:${itemIndex}`;
  const popup = document.getElementById(`item-rec-popup-${parentId}-${itemIndex}`);
  const days = popup.querySelector('.item-rec-days').value;
  const time = popup.querySelector('.item-rec-time').value;
  itemRecurring[key] = { type, parentId, itemIndex, days, time };
  popup.style.display = 'none';
  showToast('Item recurring saved!');
  if (type === 'list') renderLists();
  else renderTasks();
}

function removeItemRecurring(parentId, itemIndex, type) {
  const key = `${parentId}:${itemIndex}`;
  delete itemRecurring[key];
  showToast('Item recurring removed');
  if (type === 'list') renderLists();
  else renderTasks();
}

function saveReminder(listId, type = 'list') {
  const panelId = type === 'task' ? `task-reminder-panel-${listId}` : `reminder-panel-${listId}`;
  const panel = document.getElementById(panelId);
  const checked = panel.querySelectorAll('.device-cb:checked');
  const interval = panel.querySelector('.interval-select').value;
  const start = panel.querySelector('.start-time').value;
  const end = panel.querySelector('.end-time').value;
  if (checked.length === 0) { showToast('Select at least one device'); return; }
  const config = { devices: Array.from(checked).map(cb => cb.value), interval, start, end };
  if (type === 'task') taskReminders[listId] = config;
  else listReminders[listId] = config;
  showToast('Reminder saved!');
  if (type === 'task') renderTasks();
  else renderLists();
}

function removeReminder(listId, type = 'list') {
  if (type === 'task') delete taskReminders[listId];
  else delete listReminders[listId];
  showToast('Reminder removed');
  if (type === 'task') renderTasks();
  else renderLists();
}

function renderLists() {
  const container = document.getElementById('lists-container');
  document.getElementById('lists-count').textContent = lists.length;
  if (lists.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">‚òëÔ∏è</div><div class="empty-text">No checklists yet</div><div class="empty-hint">Create your first checklist above</div></div>`;
    return;
  }
  const allDays = [['mon','Mon'],['tue','Tue'],['wed','Wed'],['thu','Thu'],['fri','Fri'],['sat','Sat'],['sun','Sun']];
  
  container.innerHTML = lists.map(list => {
    const completed = list.items.filter(i => i.completed).length;
    const total = list.items.length;
    const hasRecurring = !!listRecurring[list.id];
    const hasReminder = !!listReminders[list.id];
    const rec = listRecurring[list.id] || { days: [], times: '06:00' };
    const rem = listReminders[list.id] || { devices: [], interval: '4h', start: '09:00', end: '21:00' };
    
    return `<div class="list-card" data-list-id="${list.id}">
      <div class="list-header">
        <div class="list-title">${escapeHtml(list.title)}
          ${hasRecurring ? '<span class="config-badge active">üîÑ Recurring</span>' : ''}
          ${hasReminder ? '<span class="config-badge reminder-active">üîî Reminder</span>' : ''}
        </div>
        <div class="list-progress">${completed}/${total}</div>
      </div>
      <div class="list-items">
        ${list.items.length === 0 ? '<div style="color:var(--text-muted);font-size:0.85rem;padding:8px;">No items yet</div>' : list.items.map((item, i) => {
          if (hideCompletedLists && item.completed) return '';
          const itemKey = `${list.id}:${i}`;
          const hasItemRec = !!itemRecurring[itemKey];
          const itemRec = itemRecurring[itemKey] || { days: 'every_day', time: '06:00' };
          return `
          <div class="list-item">
            <input type="checkbox" class="item-checkbox" ${item.completed ? 'checked' : ''} onchange="toggleItem('${list.id}',${i})">
            <span class="item-text ${item.completed ? 'completed' : ''}">${escapeHtml(item.text)}</span>
            <div style="position:relative;display:inline-flex;">
              <button class="btn btn-sm ${hasItemRec ? 'btn-success' : 'btn-secondary'}" style="padding:2px 6px;font-size:0.7rem;" onclick="toggleItemRecurring('${list.id}',${i},'list')" title="${hasItemRec ? 'Edit item recurring' : 'Add item recurring'}">‚ü≥</button>
              <div id="item-rec-popup-${list.id}-${i}" style="display:none;position:absolute;top:100%;right:0;z-index:100;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.3);min-width:200px;">
                <div style="font-size:0.85em;color:var(--success);margin-bottom:8px;font-weight:600;">Item Recurring Reset</div>
                <div style="margin-bottom:8px;">
                  <label style="font-size:0.8em;color:var(--text-muted);">Days:</label>
                  <select class="item-rec-days" style="width:100%;padding:4px;border:1px solid var(--border);border-radius:4px;background:var(--bg-elevated);color:var(--text-primary);font-size:0.85em;">
                    <option value="every_day" ${itemRec.days==='every_day'?'selected':''}>Every day</option>
                    <option value="weekdays" ${itemRec.days==='weekdays'?'selected':''}>Weekdays</option>
                    <option value="weekends" ${itemRec.days==='weekends'?'selected':''}>Weekends</option>
                    <option value="monthly" ${itemRec.days==='monthly'?'selected':''}>Monthly</option>
                    <option value="quarterly" ${itemRec.days==='quarterly'?'selected':''}>Quarterly</option>
                  </select>
                </div>
                <div style="margin-bottom:8px;">
                  <label style="font-size:0.8em;color:var(--text-muted);">Time:</label>
                  <input type="time" class="item-rec-time" value="${itemRec.time}" style="width:100%;padding:4px;border:1px solid var(--border);border-radius:4px;background:var(--bg-elevated);color:var(--text-primary);font-size:0.85em;">
                </div>
                <div style="display:flex;gap:6px;">
                  <button class="btn btn-sm btn-success" onclick="saveItemRecurring('${list.id}',${i},'list')">Save</button>
                  ${hasItemRec ? `<button class="btn btn-sm btn-danger" onclick="removeItemRecurring('${list.id}',${i},'list')">Remove</button>` : ''}
                </div>
              </div>
            </div>
            <button class="btn btn-sm btn-danger item-delete" onclick="deleteListItem('${list.id}',${i})">√ó</button>
          </div>
        `}).join('')}
      </div>
      <div class="add-item-form">
        <input type="text" id="add-item-${list.id}" placeholder="Add new item..." onkeypress="if(event.key==='Enter')addListItem('${list.id}')">
        <button class="btn btn-sm" onclick="addListItem('${list.id}')">Add</button>
      </div>
      <div class="list-actions">
        <button class="btn btn-sm btn-secondary" onclick="resetList('${list.id}')">üîÑ Reset</button>
        <button class="btn btn-sm ${hasRecurring ? 'btn-success' : 'btn-secondary'}" onclick="toggleRecurringPanel('${list.id}')">üìÖ Recurring</button>
        <button class="btn btn-sm ${hasReminder ? 'btn-purple' : 'btn-secondary'}" onclick="toggleReminderPanel('${list.id}')">üîî Remind</button>
        <button class="btn btn-sm btn-danger" onclick="deleteList('${list.id}')">Delete</button>
      </div>
      <div class="panel panel-recurring" id="recurring-panel-${list.id}">
        <div class="panel-title">üìÖ Recurring Reset</div>
        <div class="panel-row"><span class="panel-label">Days:</span>
          <div class="day-selector">${allDays.map(([d,l]) => `<button class="day-btn ${rec.days.includes(d)?'active':''}" data-day="${d}" onclick="toggleDay('${list.id}','${d}')">${l}</button>`).join('')}</div>
        </div>
        <div class="panel-row"><span class="panel-label">Time:</span>
          <select class="time-preset" style="flex:1;">${timePresets.map(t => `<option value="${t.value}" ${rec.times===t.value?'selected':''}>${t.label}</option>`).join('')}</select>
        </div>
        <div class="panel-actions">
          <button class="btn btn-sm btn-success" onclick="saveRecurring('${list.id}')">Save</button>
          ${hasRecurring ? `<button class="btn btn-sm btn-danger" onclick="removeRecurring('${list.id}')">Remove</button>` : ''}
        </div>
      </div>
      <div class="panel panel-reminder" id="reminder-panel-${list.id}">
        <div class="panel-title">üîî Reminder</div>
        <div class="panel-devices">${devices.map(d => `<label class="device-check"><input type="checkbox" class="device-cb" value="${d.id}" ${rem.devices.includes(d.id)?'checked':''}>${d.name}</label>`).join('')}</div>
        <div class="panel-row"><span class="panel-label">Interval:</span>
          <select class="interval-select" style="flex:1;"><option value="30m" ${rem.interval==='30m'?'selected':''}>Every 30 min</option><option value="1h" ${rem.interval==='1h'?'selected':''}>Every hour</option><option value="2h" ${rem.interval==='2h'?'selected':''}>Every 2 hours</option><option value="4h" ${rem.interval==='4h'?'selected':''}>Every 4 hours</option></select>
        </div>
        <div class="panel-row"><span class="panel-label">Active:</span>
          <input type="time" class="start-time" value="${rem.start}" style="width:100px;"> <span style="color:var(--text-muted)">to</span> <input type="time" class="end-time" value="${rem.end}" style="width:100px;">
        </div>
        <div class="panel-actions">
          <button class="btn btn-sm btn-purple" onclick="saveReminder('${list.id}')">Save</button>
          ${hasReminder ? `<button class="btn btn-sm btn-danger" onclick="removeReminder('${list.id}')">Remove</button>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

function createTaskList() {
  const title = document.getElementById('task-list-title').value.trim();
  if (!title) { showToast('Please enter a title'); return; }
  taskLists.unshift({ 
    id: generateId(), 
    title, 
    statuses: [
      { id: 'todo', label: 'To Do', color: '#6b7280', order: 0 },
      { id: 'in_progress', label: 'In Progress', color: '#3b82f6', order: 1 },
      { id: 'completed', label: 'Completed', color: '#10b981', order: 2 }
    ],
    items: [] 
  });
  document.getElementById('task-list-title').value = '';
  renderTasks();
  renderKanban();
  showToast('Task list created!');
}

function deleteTaskList(id) {
  if (confirm('Delete this task list?')) {
    const card = document.querySelector(`[data-task-id="${id}"]`);
    if (card) {
      card.classList.add('dissipating');
      setTimeout(() => {
        taskLists = taskLists.filter(t => t.id !== id);
        delete taskReminders[id];
        renderTasks();
        renderKanban();
        showToast('Task list deleted');
      }, 400);
    } else {
      taskLists = taskLists.filter(t => t.id !== id);
      delete taskReminders[id];
      renderTasks();
      renderKanban();
      showToast('Task list deleted');
    }
  }
}

function addTaskItem(taskListId, parentIndex = null) {
  const taskList = taskLists.find(t => t.id === taskListId);
  const inputId = parentIndex !== null ? `add-subtask-${taskListId}-${parentIndex}` : `add-task-${taskListId}`;
  const input = document.getElementById(inputId);
  const text = input.value.trim();
  if (!text) return;
  const newItem = { id: generateId(), text, status: 'todo', depth: parentIndex !== null ? taskList.items[parentIndex].depth + 1 : 0 };
  if (parentIndex !== null) {
    let insertAt = parentIndex + 1;
    while (insertAt < taskList.items.length && taskList.items[insertAt].depth > taskList.items[parentIndex].depth) insertAt++;
    taskList.items.splice(insertAt, 0, newItem);
  } else taskList.items.push(newItem);
  input.value = '';
  renderTasks();
  renderKanban();
}

function updateTaskStatus(taskListId, itemIndex, newStatus) {
  const taskList = taskLists.find(t => t.id === taskListId);
  taskList.items[itemIndex].status = newStatus;
  if (newStatus === 'completed') {
    const parentDepth = taskList.items[itemIndex].depth;
    for (let i = itemIndex + 1; i < taskList.items.length; i++) {
      if (taskList.items[i].depth > parentDepth) taskList.items[i].status = 'completed';
      else break;
    }
    showToast('Task completed!');
  }
  renderTasks();
  renderKanban();
}

function deleteTaskItem(taskListId, itemIndex) {
  const taskList = taskLists.find(t => t.id === taskListId);
  const parentDepth = taskList.items[itemIndex].depth;
  let deleteCount = 1;
  for (let i = itemIndex + 1; i < taskList.items.length; i++) {
    if (taskList.items[i].depth > parentDepth) deleteCount++;
    else break;
  }
  taskList.items.splice(itemIndex, deleteCount);
  renderTasks();
  renderKanban();
}

function resetTaskList(taskListId) {
  taskLists.find(t => t.id === taskListId).items.forEach(item => item.status = 'todo');
  renderTasks();
  renderKanban();
  showToast('Task list reset!');
}

function toggleSubtaskInput(taskListId, itemIndex) {
  const form = document.getElementById(`subtask-form-${taskListId}-${itemIndex}`);
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
  if (form.style.display === 'block') form.querySelector('input').focus();
}

function toggleTaskReminderPanel(taskId) {
  document.getElementById(`task-reminder-panel-${taskId}`).classList.toggle('show');
}

function renderTasks() {
  const container = document.getElementById('tasks-container');
  document.getElementById('tasks-count').textContent = taskLists.length;
  if (taskLists.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">No task lists yet</div><div class="empty-hint">Create your first task list above</div></div>`;
    return;
  }
  
  container.innerHTML = taskLists.map(taskList => {
    const statuses = taskList.statuses || [
      { id: 'todo', label: 'To Do' },
      { id: 'in_progress', label: 'In Progress' },
      { id: 'completed', label: 'Completed' }
    ];
    const statusLabels = {};
    statuses.forEach(s => statusLabels[s.id] = s.label);
    
    const completed = taskList.items.filter(i => i.status === 'completed').length;
    const total = taskList.items.length;
    const hasReminder = !!taskReminders[taskList.id];
    const rem = taskReminders[taskList.id] || { devices: [], interval: '2h', start: '08:00', end: '20:00' };
    
    return `<div class="task-card" data-task-id="${taskList.id}">
      <div class="task-header">
        <div class="task-title">${escapeHtml(taskList.title)}
          ${hasReminder ? '<span class="config-badge reminder-active">üîî Reminder</span>' : ''}
        </div>
        <div class="task-progress">${completed}/${total}</div>
      </div>
      <div class="task-items">
        ${taskList.items.length === 0 ? '<div style="color:var(--text-muted);font-size:0.85rem;padding:8px;">No tasks yet</div>' : taskList.items.map((item, i) => {
          if (hideCompletedTasks && item.status === 'completed') return '';
          const itemKey = `${taskList.id}:${i}`;
          const hasItemRec = !!itemRecurring[itemKey];
          const itemRec = itemRecurring[itemKey] || { days: 'every_day', time: '06:00' };
          return `
          <div class="task-item depth-${Math.min(item.depth, 3)}">
            <span class="task-item-text ${item.status === 'completed' ? 'completed' : ''}">${escapeHtml(item.text)}</span>
            <select class="status-select" onchange="updateTaskStatus('${taskList.id}',${i},this.value)">
              ${statuses.map(s => `<option value="${s.id}" ${item.status === s.id ? 'selected' : ''}>${statusLabels[s.id]}</option>`).join('')}
            </select>
            <div class="task-item-actions">
              <div style="position:relative;display:inline-flex;">
                <button class="btn btn-sm ${hasItemRec ? 'btn-success' : 'btn-secondary'}" style="padding:2px 6px;font-size:0.7rem;" onclick="toggleItemRecurring('${taskList.id}',${i},'task')" title="${hasItemRec ? 'Edit item recurring' : 'Add item recurring'}">‚ü≥</button>
                <div id="item-rec-popup-${taskList.id}-${i}" style="display:none;position:absolute;top:100%;right:0;z-index:100;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,0.3);min-width:200px;">
                  <div style="font-size:0.85em;color:var(--success);margin-bottom:8px;font-weight:600;">Item Recurring Reset</div>
                  <div style="margin-bottom:8px;">
                    <label style="font-size:0.8em;color:var(--text-muted);">Days:</label>
                    <select class="item-rec-days" style="width:100%;padding:4px;border:1px solid var(--border);border-radius:4px;background:var(--bg-elevated);color:var(--text-primary);font-size:0.85em;">
                      <option value="every_day" ${itemRec.days==='every_day'?'selected':''}>Every day</option>
                      <option value="weekdays" ${itemRec.days==='weekdays'?'selected':''}>Weekdays</option>
                      <option value="weekends" ${itemRec.days==='weekends'?'selected':''}>Weekends</option>
                      <option value="monthly" ${itemRec.days==='monthly'?'selected':''}>Monthly</option>
                      <option value="quarterly" ${itemRec.days==='quarterly'?'selected':''}>Quarterly</option>
                    </select>
                  </div>
                  <div style="margin-bottom:8px;">
                    <label style="font-size:0.8em;color:var(--text-muted);">Time:</label>
                    <input type="time" class="item-rec-time" value="${itemRec.time}" style="width:100%;padding:4px;border:1px solid var(--border);border-radius:4px;background:var(--bg-elevated);color:var(--text-primary);font-size:0.85em;">
                  </div>
                  <div style="display:flex;gap:6px;">
                    <button class="btn btn-sm btn-success" onclick="saveItemRecurring('${taskList.id}',${i},'task')">Save</button>
                    ${hasItemRec ? `<button class="btn btn-sm btn-danger" onclick="removeItemRecurring('${taskList.id}',${i},'task')">Remove</button>` : ''}
                  </div>
                </div>
              </div>
              <button class="btn btn-sm btn-icon" onclick="toggleSubtaskInput('${taskList.id}',${i})" title="Add subtask">+</button>
              <button class="btn btn-sm btn-danger" onclick="deleteTaskItem('${taskList.id}',${i})">√ó</button>
            </div>
          </div>
          <div id="subtask-form-${taskList.id}-${i}" style="display:none;margin-left:${(Math.min(item.depth,3)+1)*20}px;margin-bottom:6px;">
            <div style="display:flex;gap:8px;">
              <input type="text" id="add-subtask-${taskList.id}-${i}" placeholder="Add subtask..." style="flex:1;" onkeypress="if(event.key==='Enter')addTaskItem('${taskList.id}',${i})">
              <button class="btn btn-sm" onclick="addTaskItem('${taskList.id}',${i})">Add</button>
            </div>
          </div>
        `}).join('')}
      </div>
      <div class="add-task-form">
        <input type="text" id="add-task-${taskList.id}" placeholder="Add new task..." onkeypress="if(event.key==='Enter')addTaskItem('${taskList.id}')">
        <button class="btn btn-sm" onclick="addTaskItem('${taskList.id}')">Add Task</button>
      </div>
      <div class="task-actions">
        <button class="btn btn-sm btn-secondary" onclick="resetTaskList('${taskList.id}')">üîÑ Reset All</button>
        <button class="btn btn-sm ${hasReminder ? 'btn-purple' : 'btn-secondary'}" onclick="toggleTaskReminderPanel('${taskList.id}')">üîî Remind</button>
        <button class="btn btn-sm btn-danger" onclick="deleteTaskList('${taskList.id}')">Delete</button>
      </div>
      <div class="panel panel-reminder" id="task-reminder-panel-${taskList.id}">
        <div class="panel-title">üîî Reminder</div>
        <div class="panel-devices">${devices.map(d => `<label class="device-check"><input type="checkbox" class="device-cb" value="${d.id}" ${rem.devices.includes(d.id)?'checked':''}>${d.name}</label>`).join('')}</div>
        <div class="panel-row"><span class="panel-label">Interval:</span>
          <select class="interval-select" style="flex:1;"><option value="30m" ${rem.interval==='30m'?'selected':''}>Every 30 min</option><option value="1h" ${rem.interval==='1h'?'selected':''}>Every hour</option><option value="2h" ${rem.interval==='2h'?'selected':''}>Every 2 hours</option><option value="4h" ${rem.interval==='4h'?'selected':''}>Every 4 hours</option></select>
        </div>
        <div class="panel-row"><span class="panel-label">Active:</span>
          <input type="time" class="start-time" value="${rem.start}" style="width:100px;"> <span style="color:var(--text-muted)">to</span> <input type="time" class="end-time" value="${rem.end}" style="width:100px;">
        </div>
        <div class="panel-actions">
          <button class="btn btn-sm btn-purple" onclick="saveReminder('${taskList.id}','task')">Save</button>
          ${hasReminder ? `<button class="btn btn-sm btn-danger" onclick="removeReminder('${taskList.id}','task')">Remove</button>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderKanban() {
  const container = document.getElementById('kanban-container');
  
  if (taskLists.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-text">No task lists for Kanban</div><div class="empty-hint">Create a task list in the Tasks tab first</div></div>`;
    return;
  }
  
  container.innerHTML = taskLists.map(taskList => {
    const statuses = taskList.statuses || [
      { id: 'todo', label: 'To Do', color: '#6b7280', order: 0 },
      { id: 'in_progress', label: 'In Progress', color: '#3b82f6', order: 1 },
      { id: 'completed', label: 'Completed', color: '#10b981', order: 2 }
    ];
    const sortedStatuses = [...statuses].sort((a, b) => (a.order || 0) - (b.order || 0));
    
    const topLevelItems = taskList.items.filter(item => item.depth === 0);
    const completed = taskList.items.filter(i => i.status === 'completed').length;
    const total = taskList.items.length;
    
    return `<div class="kanban-task-card" data-taskid="${taskList.id}">
      <div class="kanban-header">
        <div class="kanban-title">${escapeHtml(taskList.title)}</div>
        <div style="display:flex;align-items:center;">
          <button class="kanban-layout-btn" onclick="toggleKanbanLayout(this)">‚¨ç Vertical</button>
          <div class="kanban-progress">${completed}/${total}</div>
        </div>
      </div>
      
      <div class="kanban-board">
        ${sortedStatuses.map(status => {
          const statusItems = topLevelItems.filter(item => item.status === status.id);
          const color = status.color || '#6b7280';
          
          return `<div class="kanban-column">
            <div class="kanban-col-header" style="background:${color}33;color:${color};">
              <div class="kanban-col-dot" style="background:${color};"></div>
              <span>${status.label}</span>
              <span class="kanban-col-count">${statusItems.length}</span>
            </div>
            
            <div class="kanban-dropzone" 
                 data-taskid="${taskList.id}" 
                 data-status="${status.id}"
                 style="border-color:${color}55;"
                 ondragover="event.preventDefault();this.classList.add('drag-over');"
                 ondragleave="this.classList.remove('drag-over');"
                 ondrop="handleKanbanDrop(event, this)">
              
              ${statusItems.length === 0 ? '<div class="kanban-empty">Drop here</div>' : statusItems.map((item, idx) => {
                const itemIndex = taskList.items.findIndex(i => i.id === item.id);
                const children = [];
                for (let i = itemIndex + 1; i < taskList.items.length; i++) {
                  if (taskList.items[i].depth > item.depth) children.push(taskList.items[i]);
                  else break;
                }
                
                return `<div class="kanban-item" 
                             draggable="true"
                             style="border-left-color:${color};"
                             ondragstart="handleKanbanDragStart(event, '${taskList.id}', ${itemIndex})"
                             ondragend="this.classList.remove('dragging')"
                             ontouchstart="handleTouchStart(event, '${taskList.id}', ${itemIndex})"
                             ontouchmove="handleTouchMove(event)"
                             ontouchend="handleTouchEnd(event)">>
                  <div class="kanban-item-text">${escapeHtml(item.text)}</div>
                  ${children.length > 0 ? `
                    <div class="kanban-item-children">
                      ${children.slice(0, 3).map(child => {
                        const childColor = (statuses.find(s => s.id === child.status) || {}).color || '#6b7280';
                        return `<div class="kanban-child">
                          <div class="kanban-child-dot" style="background:${childColor};"></div>
                          <span>${escapeHtml(child.text)}</span>
                        </div>`;
                      }).join('')}
                      ${children.length > 3 ? `<div class="kanban-child" style="color:var(--text-muted);">+${children.length - 3} more</div>` : ''}
                    </div>
                  ` : ''}
                </div>`;
              }).join('')}
            </div>
            
            <div class="kanban-add-row">
              <input type="text" placeholder="New item..." id="kanban-add-${taskList.id}-${status.id}" onkeypress="if(event.key==='Enter')addKanbanItem('${taskList.id}','${status.id}')">
              <button class="btn btn-sm" onclick="addKanbanItem('${taskList.id}','${status.id}')">Add</button>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  }).join('');
}

function toggleKanbanLayout(btn) {
  const board = btn.closest('.kanban-task-card').querySelector('.kanban-board');
  board.classList.toggle('vertical');
  btn.textContent = board.classList.contains('vertical') ? '‚¨å Horizontal' : '‚¨ç Vertical';
}

function handleKanbanDragStart(event, taskId, itemIndex) {
  event.target.classList.add('dragging');
  event.dataTransfer.setData('text/plain', `${taskId}|||${itemIndex}`);
  event.dataTransfer.effectAllowed = 'move';
}

function handleKanbanDrop(event, zone) {
  event.preventDefault();
  zone.classList.remove('drag-over');
  
  const data = event.dataTransfer.getData('text/plain');
  if (!data) return;
  
  const [taskId, itemIndex] = data.split('|||');
  const newStatus = zone.dataset.status;
  
  if (taskId !== zone.dataset.taskid) return;
  
  updateTaskStatus(taskId, parseInt(itemIndex), newStatus);
}

let touchDragData = null;
let touchDragElement = null;
let touchDragClone = null;
let touchStartTimer = null;
let touchStartPos = null;

function handleTouchStart(event, taskId, itemIndex) {
  const touch = event.touches[0];
  const target = event.currentTarget;
  
  touchStartPos = { x: touch.clientX, y: touch.clientY };
  
  touchStartTimer = setTimeout(() => {
    touchDragData = { taskId, itemIndex };
    touchDragElement = target;
    
    if (navigator.vibrate) navigator.vibrate(50);
    
    touchDragClone = target.cloneNode(true);
    touchDragClone.style.cssText = `
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      opacity: 0.9;
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      width: ${target.offsetWidth}px;
      left: ${touch.clientX - target.offsetWidth / 2}px;
      top: ${touch.clientY - 20}px;
      border-radius: 8px;
      background: var(--bg-card);
    `;
    document.body.appendChild(touchDragClone);
    
    target.style.opacity = '0.3';
    
    document.querySelectorAll(`.kanban-dropzone[data-taskid="${taskId}"]`).forEach(zone => {
      zone.style.borderStyle = 'dashed';
      zone.style.borderWidth = '2px';
    });
  }, 200);
}

function handleTouchMove(event) {
  const touch = event.touches[0];
  
  if (touchStartTimer && touchStartPos) {
    const dx = Math.abs(touch.clientX - touchStartPos.x);
    const dy = Math.abs(touch.clientY - touchStartPos.y);
    if (dx > 10 || dy > 10) {
      clearTimeout(touchStartTimer);
      touchStartTimer = null;
    }
  }
  
  if (!touchDragClone) return;
  event.preventDefault();
  
  touchDragClone.style.left = `${touch.clientX - touchDragClone.offsetWidth / 2}px`;
  touchDragClone.style.top = `${touch.clientY - 20}px`;
  
  const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
  const dropzone = elemBelow?.closest('.kanban-dropzone');
  

  document.querySelectorAll('.kanban-dropzone').forEach(z => z.classList.remove('drag-over'));
  if (dropzone && dropzone.dataset.taskid === touchDragData.taskId) {
    dropzone.classList.add('drag-over');
  }
}

function handleTouchEnd(event) {
  if (touchStartTimer) {
    clearTimeout(touchStartTimer);
    touchStartTimer = null;
  }
  
  if (!touchDragData || !touchDragClone) {
    touchDragData = null;
    return;
  }
  
  const touch = event.changedTouches[0];
  const elemBelow = document.elementFromPoint(touch.clientX, touch.clientY);
  const dropzone = elemBelow?.closest('.kanban-dropzone');
  
  if (touchDragClone) {
    touchDragClone.remove();
    touchDragClone = null;
  }
  if (touchDragElement) {
    touchDragElement.style.opacity = '1';
    touchDragElement = null;
  }
  document.querySelectorAll('.kanban-dropzone').forEach(zone => {
    zone.classList.remove('drag-over');
    zone.style.borderStyle = '';
    zone.style.borderWidth = '';
  });
  
  if (dropzone && dropzone.dataset.taskid === touchDragData.taskId) {
    const newStatus = dropzone.dataset.status;
    updateTaskStatus(touchDragData.taskId, touchDragData.itemIndex, newStatus);
  }
  
  touchDragData = null;
  touchStartPos = null;
}

function addKanbanItem(taskListId, statusId) {
  const input = document.getElementById(`kanban-add-${taskListId}-${statusId}`);
  const text = input.value.trim();
  if (!text) return;
  
  const taskList = taskLists.find(t => t.id === taskListId);
  taskList.items.push({ id: generateId(), text, status: statusId, depth: 0 });
  input.value = '';
  
  renderTasks();
  renderKanban();
  showToast('Item added!');
}

function generateId() { return 'xxxx-xxxx-xxxx'.replace(/x/g, () => Math.floor(Math.random() * 16).toString(16)); }
function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
function formatDate(isoString) { return new Date(isoString).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); }
function renderMarkdown(text) {
  return text.replace(/^### (.+)$/gm, '<h3>$1</h3>').replace(/^## (.+)$/gm, '<h2>$1</h2>').replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\*(.+?)\*/g, '<em>$1</em>').replace(/`(.+?)`/g, '<code>$1</code>')
    .replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>').replace(/^- (.+)$/gm, '<li>$1</li>').replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>').replace(/\n/g, '<br>');
}
function openImageModal(src) { document.getElementById('modal-image').src = src; document.getElementById('image-modal').classList.add('show'); }
function closeImageModal() { document.getElementById('image-modal').classList.remove('show'); }
function showToast(message) { const toast = document.getElementById('toast'); toast.textContent = message; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 2500); }

function generateCalendarEvents() {
  calendarEvents = [];
  const today = formatDateISO(new Date());
  
  notes.forEach(note => {
    calendarEvents.push({ date: note.created.split('T')[0], title: note.title, type: 'note-created', color: eventColors['note-created'] });
  });
  
  lists.forEach(list => {
    if (list.dueDate) {
      calendarEvents.push({ date: list.dueDate, title: list.title, type: 'list-due', color: eventColors['list-due'] });
    }
  });
  
  taskLists.forEach(taskList => {
    taskList.items.forEach(item => {
      if (item.dueDate) {
        const isOverdue = item.dueDate < today && item.status !== 'completed';
        calendarEvents.push({
          date: item.dueDate,
          title: `${taskList.title}: ${item.text}`,
          type: isOverdue ? 'task-overdue' : 'task-due',
          color: isOverdue ? eventColors['task-overdue'] : eventColors['task-due']
        });
      }
    });
  });
  
  const now = new Date();
  calendarEvents.push(
    { date: formatDateISO(new Date(now.getFullYear(), now.getMonth(), 15)), title: 'Team Meeting', type: 'imported', color: eventColors['imported'] },
    { date: formatDateISO(new Date(now.getFullYear(), now.getMonth(), 22)), title: 'Doctor Appointment', type: 'imported', color: eventColors['imported'] }
  );
}

function renderCalendar() {
  generateCalendarEvents();
  const grid = document.getElementById('calendar-grid');
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const today = new Date();
  const todayStr = formatDateISO(today);
  
  document.getElementById('calendar-month-title').textContent = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const prevMonthDays = new Date(year, month, 0).getDate();
  
  const eventsByDate = {};
  calendarEvents.forEach(e => {
    if (!eventsByDate[e.date]) eventsByDate[e.date] = [];
    eventsByDate[e.date].push(e);
  });
  
  let html = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => `<div class="calendar-weekday">${d}</div>`).join('');
  
  for (let i = firstDay - 1; i >= 0; i--) {
    html += `<div class="calendar-day other-month"><span class="day-number">${prevMonthDays - i}</span></div>`;
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const isToday = dateStr === todayStr;
    const dayEvents = eventsByDate[dateStr] || [];
    
    html += `<div class="calendar-day ${isToday ? 'today' : ''} ${dayEvents.length ? 'has-events' : ''}">
      <span class="day-number">${day}</span>
      <div class="day-events">
        ${dayEvents.slice(0, 3).map(e => `<div class="day-event" style="background:${e.color};color:#fff;">${escapeHtml(e.title)}</div>`).join('')}
        ${dayEvents.length > 3 ? `<div class="day-more">+${dayEvents.length - 3} more</div>` : ''}
      </div>
    </div>`;
  }
  
  const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
  for (let i = 1; i <= totalCells - firstDay - daysInMonth; i++) {
    html += `<div class="calendar-day other-month"><span class="day-number">${i}</span></div>`;
  }
  
  grid.innerHTML = html;
  renderUpcomingEvents();
  renderIcalSources();
  renderColorSettings();
  renderOverdueBanner();
}

function renderUpcomingEvents() {
  const container = document.getElementById('upcoming-events');
  const todayStr = formatDateISO(new Date());
  const upcoming = calendarEvents.filter(e => e.date >= todayStr).sort((a, b) => a.date.localeCompare(b.date)).slice(0, 6);
  
  if (upcoming.length === 0) {
    container.innerHTML = '<div class="mini-cal-empty">No upcoming events</div>';
    return;
  }
  
  container.innerHTML = upcoming.map(e => `
    <div class="upcoming-event">
      <div class="upcoming-event-dot" style="background:${e.color}"></div>
      <div class="upcoming-event-content">
        <div class="upcoming-event-title">${escapeHtml(e.title)}</div>
        <div class="upcoming-event-time">${formatEventDate(e.date)}</div>
      </div>
    </div>
  `).join('');
}

function renderIcalSources() {
  const container = document.getElementById('ical-sources');
  if (icalSources.length === 0) {
    container.innerHTML = '<div class="mini-cal-empty">No calendars imported</div>';
    return;
  }
  container.innerHTML = icalSources.map((s, i) => `
    <div class="ical-source">
      <div>
        <div class="ical-source-name">${escapeHtml(s.name)}</div>
        <div class="ical-source-status">‚úì Synced</div>
      </div>
      <button class="btn btn-sm btn-danger" onclick="removeIcalSource(${i})">√ó</button>
    </div>
  `).join('');
}

function renderColorSettings() {
  const container = document.getElementById('color-settings');
  const colorTypes = [
    { key: 'note-created', label: 'Note Created' },
    { key: 'note-edited', label: 'Note Edited' },
    { key: 'list-due', label: 'List Due' },
    { key: 'task-due', label: 'Task Due' },
    { key: 'task-overdue', label: 'Overdue' },
    { key: 'imported', label: 'Imported' }
  ];
  
  container.innerHTML = colorTypes.map(t => `
    <div class="color-row">
      <span class="color-label"><span class="color-preview" style="background:${eventColors[t.key]}"></span>${t.label}</span>
      <input type="color" class="color-input" value="${eventColors[t.key]}" onchange="updateColor('${t.key}', this.value)">
    </div>
  `).join('');
}

function renderOverdueBanner() {
  const container = document.getElementById('overdue-banner-container');
  const overdueCount = calendarEvents.filter(e => e.type === 'task-overdue').length;
  
  if (overdueCount > 0) {
    container.innerHTML = `<div class="overdue-banner">‚ö†Ô∏è You have <span class="overdue-count">${overdueCount}</span> overdue item${overdueCount > 1 ? 's' : ''}</div>`;
  } else {
    container.innerHTML = '';
  }
}

function updateColor(key, value) {
  eventColors[key] = value;
  renderCalendar();
  showToast('Color updated!');
}

function changeMonth(delta) {
  currentDate.setMonth(currentDate.getMonth() + delta);
  renderCalendar();
}

function goToToday() {
  currentDate = new Date();
  renderCalendar();
}

function importIcal() {
  const url = document.getElementById('ical-url').value.trim();
  const name = document.getElementById('ical-name').value.trim() || 'Imported Calendar';
  if (!url) { showToast('Please enter a calendar URL'); return; }
  icalSources.push({ name, url, status: 'synced' });
  document.getElementById('ical-url').value = '';
  document.getElementById('ical-name').value = '';
  renderIcalSources();
  showToast(`Imported "${name}"!`);
}

function removeIcalSource(index) {
  const name = icalSources[index].name;
  icalSources.splice(index, 1);
  renderIcalSources();
  showToast(`Removed "${name}"`);
}

function toggleCalendarSettings() {
  showToast('Settings panel opens in the real dashboard!');
}

function formatDateISO(date) {
  return date.toISOString().split('T')[0];
}

function formatEventDate(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  if (dateStr === formatDateISO(today)) return 'Today';
  if (dateStr === formatDateISO(tomorrow)) return 'Tomorrow';
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function renderAll() { renderNotes(); renderLists(); renderTasks(); renderKanban(); renderCalendar(); renderPoints(); }

// Points System Functions
function renderPoints() {
  renderLeaderboard();
  renderPrizes();
  renderAchievements();
  renderPointsHistory();
  renderUsersList();
  updateUserSelect();
}

function renderLeaderboard() {
  const container = document.getElementById('leaderboard-list');
  const sorted = Object.entries(pointsUsers).sort((a, b) => b[1].lifetime_points - a[1].lifetime_points);

  if (sorted.length === 0) {
    container.innerHTML = '<div class="empty-state">No users yet. Add users in the sidebar.</div>';
    return;
  }

  container.innerHTML = sorted.map(([id, user], i) => {
    const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : 'other';
    const achievements = (userAchievements[id] || []).map(aid => {
      const ach = pointsAchievements.find(a => a.id === aid);
      return ach ? 'üèÖ' : '';
    }).join('');
    return `
      <div class="leaderboard-item">
        <div class="leaderboard-rank ${rankClass}">${i + 1}</div>
        <div class="leaderboard-avatar">${user.name.charAt(0)}</div>
        <div class="leaderboard-info">
          <div class="leaderboard-name">${user.name}</div>
          <div class="leaderboard-lifetime">${user.lifetime_points} lifetime pts</div>
        </div>
        <div class="leaderboard-achievements">${achievements}</div>
        <div class="leaderboard-points">‚≠ê ${user.points}</div>
      </div>
    `;
  }).join('');
}

function renderPrizes() {
  const container = document.getElementById('prizes-list');
  if (pointsPrizes.length === 0) {
    container.innerHTML = '<div class="empty-state">No prizes yet. Add one above!</div>';
    return;
  }
  container.innerHTML = pointsPrizes.map(prize => `
    <div class="prize-item">
      <div class="prize-icon">üéÅ</div>
      <div class="prize-info">
        <div class="prize-name">${prize.name}</div>
        <div class="prize-desc">${prize.description || ''}</div>
      </div>
      <div class="prize-cost">‚≠ê ${prize.cost}</div>
      <button class="btn btn-sm btn-danger" onclick="deletePrize('${prize.id}')">√ó</button>
    </div>
  `).join('');
}

function renderAchievements() {
  const container = document.getElementById('achievements-list');
  if (pointsAchievements.length === 0) {
    container.innerHTML = '<div class="empty-state">No achievements yet. Add one above!</div>';
    return;
  }
  container.innerHTML = pointsAchievements.map(ach => `
    <div class="achievement-item">
      <div class="achievement-icon">üèÜ</div>
      <div class="achievement-info">
        <div class="achievement-name">${ach.name}</div>
        <div class="achievement-desc">${ach.description || ''}</div>
        <div class="achievement-threshold">${ach.points_threshold > 0 ? 'Auto @ ' + ach.points_threshold + ' pts' : 'Manual award'}</div>
      </div>
      <button class="btn btn-sm btn-danger" onclick="deleteAchievement('${ach.id}')">√ó</button>
    </div>
  `).join('');
}

function renderPointsHistory() {
  const container = document.getElementById('history-list');
  if (pointsHistory.length === 0) {
    container.innerHTML = '<div class="empty-state">No history yet.</div>';
    return;
  }
  container.innerHTML = pointsHistory.slice(0, 10).map(h => {
    const timeAgo = getTimeAgo(new Date(h.timestamp));
    return `
      <div class="history-item">
        <span class="history-amount ${h.amount >= 0 ? 'positive' : 'negative'}">${h.amount >= 0 ? '+' : ''}${h.amount}</span>
        <span>${h.user_name}</span>
        <span class="history-reason">${h.reason || ''}</span>
        <span class="history-time">${timeAgo}</span>
      </div>
    `;
  }).join('');
}

function renderUsersList() {
  const container = document.getElementById('users-list');
  const users = Object.entries(pointsUsers);
  if (users.length === 0) {
    container.innerHTML = '<div class="empty-state">No users yet.</div>';
    return;
  }
  container.innerHTML = users.map(([id, user]) => `
    <div class="user-item">
      <div class="leaderboard-avatar">${user.name.charAt(0)}</div>
      <div class="user-info">
        <div class="user-name">${user.name}</div>
      </div>
      <div class="user-points">‚≠ê ${user.points}</div>
      <button class="btn btn-sm btn-danger" onclick="deletePointsUser('${id}')">√ó</button>
    </div>
  `).join('');
}

function updateUserSelect() {
  const select = document.getElementById('action-user');
  select.innerHTML = '<option value="">Select user...</option>' +
    Object.entries(pointsUsers).map(([id, user]) => `<option value="${id}">${user.name}</option>`).join('');
}

function getTimeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  if (seconds < 60) return 'just now';
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return minutes + 'm ago';
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return hours + 'h ago';
  const days = Math.floor(hours / 24);
  return days + 'd ago';
}

function toggleAddPrize() {
  const form = document.getElementById('add-prize-form');
  form.style.display = form.style.display === 'none' ? 'flex' : 'none';
}

function toggleAddAchievement() {
  const form = document.getElementById('add-achievement-form');
  form.style.display = form.style.display === 'none' ? 'flex' : 'none';
}

function addPointsUser() {
  const name = document.getElementById('new-user-name').value.trim();
  if (!name) { showToast('Please enter a name'); return; }
  const id = generateId();
  pointsUsers[id] = { name, points: 0, lifetime_points: 0 };
  userAchievements[id] = [];
  document.getElementById('new-user-name').value = '';
  renderPoints();
  showToast('User added!');
}

function deletePointsUser(id) {
  if (confirm('Delete this user?')) {
    delete pointsUsers[id];
    delete userAchievements[id];
    pointsHistory = pointsHistory.filter(h => h.user_id !== id);
    renderPoints();
    showToast('User deleted');
  }
}

function addPrize() {
  const name = document.getElementById('prize-name').value.trim();
  const cost = parseInt(document.getElementById('prize-cost').value) || 100;
  const description = document.getElementById('prize-desc').value.trim();
  if (!name) { showToast('Please enter a prize name'); return; }
  pointsPrizes.push({ id: generateId(), name, cost, description });
  document.getElementById('prize-name').value = '';
  document.getElementById('prize-cost').value = '100';
  document.getElementById('prize-desc').value = '';
  toggleAddPrize();
  renderPoints();
  showToast('Prize added!');
}

function deletePrize(id) {
  if (confirm('Delete this prize?')) {
    pointsPrizes = pointsPrizes.filter(p => p.id !== id);
    renderPoints();
    showToast('Prize deleted');
  }
}

function addAchievement() {
  const name = document.getElementById('ach-name').value.trim();
  const description = document.getElementById('ach-desc').value.trim();
  const threshold = parseInt(document.getElementById('ach-threshold').value) || 0;
  if (!name) { showToast('Please enter an achievement name'); return; }
  pointsAchievements.push({ id: generateId(), name, description, points_threshold: threshold });
  document.getElementById('ach-name').value = '';
  document.getElementById('ach-desc').value = '';
  document.getElementById('ach-threshold').value = '0';
  toggleAddAchievement();
  renderPoints();
  showToast('Achievement added!');
}

function deleteAchievement(id) {
  if (confirm('Delete this achievement?')) {
    pointsAchievements = pointsAchievements.filter(a => a.id !== id);
    Object.keys(userAchievements).forEach(uid => {
      userAchievements[uid] = userAchievements[uid].filter(aid => aid !== id);
    });
    renderPoints();
    showToast('Achievement deleted');
  }
}

function quickAddPoints() {
  const userId = document.getElementById('action-user').value;
  const amount = parseInt(document.getElementById('action-points').value) || 0;
  const reason = document.getElementById('action-reason').value.trim();
  if (!userId) { showToast('Please select a user'); return; }
  if (amount <= 0) { showToast('Please enter a positive amount'); return; }

  pointsUsers[userId].points += amount;
  pointsUsers[userId].lifetime_points += amount;
  pointsHistory.unshift({
    id: generateId(),
    user_id: userId,
    user_name: pointsUsers[userId].name,
    amount: amount,
    reason: reason || 'Points added',
    timestamp: new Date().toISOString()
  });

  checkAutoAchievements(userId);
  document.getElementById('action-reason').value = '';
  renderPoints();
  showToast(`+${amount} points to ${pointsUsers[userId].name}!`);
}

function quickRemovePoints() {
  const userId = document.getElementById('action-user').value;
  const amount = parseInt(document.getElementById('action-points').value) || 0;
  const reason = document.getElementById('action-reason').value.trim();
  if (!userId) { showToast('Please select a user'); return; }
  if (amount <= 0) { showToast('Please enter a positive amount'); return; }

  pointsUsers[userId].points = Math.max(0, pointsUsers[userId].points - amount);
  pointsHistory.unshift({
    id: generateId(),
    user_id: userId,
    user_name: pointsUsers[userId].name,
    amount: -amount,
    reason: reason || 'Points removed',
    timestamp: new Date().toISOString()
  });

  document.getElementById('action-reason').value = '';
  renderPoints();
  showToast(`-${amount} points from ${pointsUsers[userId].name}`);
}

function checkAutoAchievements(userId) {
  const user = pointsUsers[userId];
  if (!user) return;

  pointsAchievements.forEach(ach => {
    if (ach.points_threshold > 0 && user.lifetime_points >= ach.points_threshold) {
      if (!userAchievements[userId].includes(ach.id)) {
        userAchievements[userId].push(ach.id);
        showToast(`üèÜ ${user.name} earned "${ach.name}"!`);
      }
    }
  });
}
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeImageModal(); });
</script>

</body>
</html>
